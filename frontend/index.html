<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G13 - BTCUSD Trading Bot</title>
    <style>
        /* =================================================================
           G13 - STYLES
           REGLE: Toutes les polices >= 18px
           ================================================================= */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --accent-pink: #ec4899;
            --accent-purple: #8b5cf6;
            --border: #475569;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 18px;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .header-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .status-badge.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .status-badge.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        /* VOYANT TRADING TRES VISIBLE */
        .trading-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 22px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .trading-indicator .indicator-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .trading-indicator.trading-active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1));
            color: #10b981;
            border: 2px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .trading-indicator.trading-active .indicator-dot {
            background: #10b981;
            box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
            animation: pulse-green 1.5s ease-in-out infinite;
        }

        .trading-indicator.trading-stopped {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1));
            color: #ef4444;
            border: 2px solid #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .trading-indicator.trading-stopped .indicator-dot {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        @keyframes pulse-green {

            0%,
            100% {
                box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 20px #10b981, 0 0 40px #10b981, 0 0 60px #10b981;
                transform: scale(1.2);
            }
        }

        /* Main container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Grid layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            align-items: start;
        }

        .grid-3-equal {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .grid-3-equal>.card {
            display: flex;
            flex-direction: column;
            height: 520px;
        }

        .grid-3-equal>.card>div:last-child {
            flex: 1;
            overflow-y: auto;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title .icon {
            font-size: 24px;
        }

        /* Price display */
        .price-display {
            text-align: center;
            padding: 30px;
        }

        .price-value {
            font-size: 48px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .price-change {
            font-size: 24px;
            margin-top: 10px;
        }

        .price-change.positive {
            color: var(--accent-green);
        }

        .price-change.negative {
            color: var(--accent-red);
        }

        /* Data rows */
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 18px;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: var(--text-secondary);
        }

        .data-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-value.positive {
            color: var(--accent-green);
        }

        .data-value.negative {
            color: var(--accent-red);
        }

        /* Agent cards */
        .agent-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid var(--border);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }

        .agent-card.inactive-trading {
            opacity: 0.6;
            filter: grayscale(50%);
            transform: scale(0.98);
            border-style: dashed;
        }

        /* Toggle toujours visible et cliquable meme sur carte inactive */
        .agent-card.inactive-trading .toggle {
            opacity: 1;
            filter: none;
            position: relative;
            z-index: 10;
        }

        .agent-card.inactive-trading .toggle-slider {
            cursor: pointer;
            background: var(--accent-red) !important;
        }

        .agent-card.inactive-trading .agent-header {
            opacity: 1;
            filter: none;
        }

        .agent-card.active-trading {
            opacity: 1;
            filter: none;
            transform: scale(1);
            border-style: solid;
        }

        .agent-card.active-trading.fibo1 {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            animation: pulse-blue 3s infinite;
        }

        .agent-card.active-trading.fibo {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
            animation: pulse-green-card 3s infinite;
        }

        .agent-card.active-trading.fibo3 {
            border-color: var(--accent-orange);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            animation: pulse-orange 3s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
            }

            50% {
                box-shadow: 0 0 25px rgba(59, 130, 246, 0.5);
            }

            100% {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
            }
        }

        @keyframes pulse-green-card {
            0% {
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
            }

            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
            }

            100% {
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
            }
        }

        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
            }

            50% {
                box-shadow: 0 0 25px rgba(245, 158, 11, 0.5);
            }

            100% {
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.2);
            }
        }

        .agent-card.fibo1 {
            border-left: 6px solid var(--accent-blue);
        }

        .agent-card.fibo {
            border-left: 6px solid var(--accent-green);
        }

        .agent-card.fibo3 {
            border-left: 6px solid var(--accent-orange);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .agent-name {
            font-size: 24px;
            font-weight: 700;
        }

        .agent-status {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 600;
        }

        .agent-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .agent-status.idle {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        .agent-status.disabled {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .agent-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 18px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Tooltip icon */
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 50%;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-blue);
            cursor: help;
            margin-left: 6px;
            vertical-align: middle;
        }

        .tooltip-icon:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Control panel */
        .control-panel {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 18px;
        }

        th,
        td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 18px;
        }

        td {
            font-size: 18px;
        }

        /* Position row */
        .position-row {
            background: var(--bg-input);
            border-radius: 6px;
            margin-bottom: 6px;
            padding: 10px 12px;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .position-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .position-direction {
            font-size: 18px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .position-direction.buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .position-direction.sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .position-agent {
            font-size: 18px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        .position-profit {
            font-size: 18px;
            font-weight: 700;
        }

        /* Metrics grid - 5 colonnes pour tous les indicateurs sur une ligne */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* Session badge */
        .session-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            background: var(--bg-input);
        }

        .killzone-container {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            justify-content: center;
        }

        .killzone-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .killzone-item.active {
            opacity: 1;
            transform: scale(1.1);
        }

        .killzone-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #666;
        }

        .killzone-item.active .killzone-dot {
            box-shadow: 0 0 10px currentColor;
            background: currentColor;
        }

        .killzone-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .killzone-item.active .killzone-label {
            color: var(--text-primary);
        }

        /* News Alert */
        .news-alert {
            display: none;
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .session-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .session-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
        }

        .session-badge.low {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        /* Fear & Greed gauge */
        .gauge {
            width: 100%;
            height: 24px;
            background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
            border-radius: 12px;
            position: relative;
            margin: 16px 0;
        }

        .gauge-marker {
            position: absolute;
            width: 8px;
            height: 32px;
            background: white;
            border-radius: 4px;
            top: -4px;
            transform: translateX(-50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Activity log */
        .log-entry {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 18px;
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 18px;
        }

        .log-agent {
            font-weight: 600;
            margin: 0 8px;
        }

        .log-action {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 600;
        }

        .log-action.buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .log-action.sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .log-action.hold {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        /* Sections */
        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        /* Toggle switch */
        .toggle {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .toggle input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
            z-index: 20;
            margin: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-input);
            border-radius: 32px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle input:checked+.toggle-slider {
            background: var(--accent-green);
        }

        .toggle input:checked+.toggle-slider:before {
            transform: translateX(28px);
        }

        /* Config inputs */
        .config-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .config-row label {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .config-row input[type="number"],
        .config-row input[type="text"],
        .config-row input[type="password"] {
            min-width: 140px;
            padding: 12px 16px;
            font-size: 18px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .config-row input[type="number"] {
            text-align: right;
        }

        .config-row input[type="number"]:focus,
        .config-row input[type="text"]:focus,
        .config-row input[type="password"]:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .config-row input[type="number"]:hover,
        .config-row input[type="text"]:hover,
        .config-row input[type="password"]:hover {
            border-color: var(--accent-blue);
        }

        .config-row select {
            min-width: 160px;
            padding: 12px 16px;
            font-size: 18px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .config-row select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 16px 20px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 16px;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: var(--border);
        }

        .collapsible-header h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .collapsible-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .collapsible-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            max-height: 2000px;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Agent performance chart */
        .agent-chart-container {
            height: 100px;
            margin-bottom: 16px;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .agent-chart-container:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Master chart clickable hover */
        .card[onclick]:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.3);
            border-color: var(--accent-pink) !important;
        }

        .agent-chart {
            width: 100%;
            height: 100%;
        }

        .chart-legend {
            position: absolute;
            top: 8px;
            right: 12px;
            display: flex;
            gap: 16px;
            font-size: 18px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Agent settings (under agent card) */
        .agent-settings {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .agent-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 8px 0;
        }

        .agent-settings-header span {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .agent-settings-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }

        .agent-settings-content.expanded {
            max-height: 1200px;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .metrics-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 1200px) {

            .grid-3,
            .grid-3-equal {
                grid-template-columns: 1fr 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {

            .grid-2,
            .grid-3,
            .grid-3-equal {
                grid-template-columns: 1fr;
            }

            .grid-3-equal>.card {
                height: auto;
                max-height: 400px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <h1>G13 - BTCUSD Trading Bot</h1>
        <div class="header-info">
            <span id="session-badge" class="session-badge">Session: --</span>
            <span id="mt5-status" class="status-badge disconnected">MT5: Deconnecte</span>
            <div id="trading-status" class="trading-indicator trading-stopped">
                <span class="indicator-dot"></span>
                <span class="indicator-text">TRADING ARRETE</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Message d'alerte News -->
        <div id="news-alert-box" class="news-alert">
            ⚠️ VOLATILITE ELEVEE : Annonce économique majeure détectée. Trading en pause automatique.
        </div>
        <!-- Control Panel -->
        <div class="control-panel">
            <button id="btn-start" class="btn btn-success" onclick="startTrading()">Demarrer Trading</button>
            <button id="btn-stop" class="btn btn-danger" onclick="stopTrading()">Arreter Trading</button>
            <button class="btn btn-secondary" onclick="closeAllPositions()">Fermer Toutes Positions</button>
            <button class="btn btn-secondary" onclick="refreshData()">Rafraichir</button>
        </div>

        <!-- Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div id="metric-floating-pnl" class="metric-value">-- EUR</div>
                <div class="metric-label">P&L Flottant</div>
            </div>
            <div class="metric-card">
                <div id="metric-start-capital" class="metric-value">-- EUR</div>
                <div class="metric-label">Capital Depart</div>
            </div>
            <div class="metric-card">
                <div id="metric-total-capital" class="metric-value">-- EUR</div>
                <div class="metric-label">Capital Total</div>
            </div>
            <div class="metric-card">
                <div id="metric-pnl" class="metric-value">-- EUR</div>
                <div class="metric-label">P&L Session</div>
            </div>
            <div class="metric-card">
                <div id="metric-winrate" class="metric-value">--%</div>
                <div class="metric-label">Win Rate</div>
            </div>
        </div>

        <!-- DONNEES MARCHE - UNE SEULE fenetre pliable -->
        <div class="card section" style="border-left: 4px solid var(--accent-blue);">
            <div class="card-title"
                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                onclick="toggleSection('market-data')">
                <span style="color: var(--accent-blue);">Donnees Marche (Prix + Futures + Sentiment)</span>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span id="price-value-header" style="font-size: 28px; font-weight: 700; color: #fff;">$--</span>
                    <span id="price-change-header" style="font-size: 18px; color: var(--text-secondary);">--</span>
                    <span id="market-data-icon" class="collapsible-icon">▼</span>
                </div>
            </div>
            <div id="market-data-content" class="collapsible-content">
                <!-- Prix central (visible uniquement quand deplie) -->
                <div
                    style="text-align: center; padding: 12px 0; border-bottom: 1px solid var(--border); margin-bottom: 12px;">
                    <div id="price-value" style="font-size: 42px; font-weight: 700;">$--</div>
                    <div id="price-change" class="price-change" style="font-size: 20px;">--</div>
                </div>
                <!-- Grille de donnees -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 40px; padding: 0 20px;">
                    <!-- Col 1: Prix -->
                    <div style="padding: 12px; background: rgba(59,130,246,0.05); border-radius: 8px;">
                        <div
                            style="font-size: 18px; color: var(--accent-blue); margin-bottom: 12px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                            PRIX</div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Spread</span><span
                                id="spread-value" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Mom 1m</span><span
                                id="mom-1m" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Mom 5m</span><span
                                id="mom-5m" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Volatilite</span><span
                                id="volatility" class="data-value">--</span></div>
                    </div>
                    <!-- Col 2: Futures -->
                    <div style="padding: 12px; background: rgba(245,158,11,0.05); border-radius: 8px;">
                        <div
                            style="font-size: 18px; color: var(--accent-orange); margin-bottom: 12px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                            FUTURES</div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Funding</span><span
                                id="funding-rate" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">OI 1h</span><span
                                id="oi-change" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">L/S Ratio</span><span
                                id="ls-ratio" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Orderbook</span><span
                                id="orderbook-bias" class="data-value">--</span></div>
                    </div>
                    <!-- Col 3: Sentiment -->
                    <div style="padding: 12px; background: rgba(16,185,129,0.05); border-radius: 8px;">
                        <div
                            style="font-size: 18px; color: var(--accent-green); margin-bottom: 12px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                            SENTIMENT</div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Fear/Greed</span><span
                                id="fg-value" class="data-value">--</span></div>
                        <div class="gauge" style="margin: 8px 0; height: 16px;">
                            <div id="fg-marker" class="gauge-marker" style="left: 50%; height: 20px; top: -2px;"></div>
                        </div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">News</span><span
                                id="news-sentiment" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Bias</span><span
                                id="global-bias" class="data-value">--</span></div>
                    </div>
                    <!-- Col 4: Analyse -->
                    <div style="padding: 12px; background: rgba(139,92,246,0.05); border-radius: 8px;">
                        <div
                            style="font-size: 18px; color: var(--accent-purple); margin-bottom: 12px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                            ANALYSE</div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Tendance</span><span
                                id="analysis-bias" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Session</span><span
                                id="current-session-name" class="data-value">--</span></div>
                        <div class="data-row" style="padding: 8px 0;"><span class="data-label">Volatilite</span><span
                                id="session-volatility" class="data-value">--</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid: Compte + Positions + Decisions -->
        <div class="grid-3-equal">
            <!-- Account - Multi-compte -->
            <div class="card section">
                <div class="card-title">Comptes MT5</div>
                <!-- FIBO1 -->
                <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                    <div style="font-size: 18px; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">FIBO1</div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Login</span>
                        <span id="mt5-fibo1-login" class="data-value" style="font-size: 18px;">--</span>
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Balance</span>
                        <span id="mt5-fibo1-balance" class="data-value" style="font-size: 18px;">-- EUR</span>
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Equity</span>
                        <span id="mt5-fibo1-equity" class="data-value" style="font-size: 18px;">-- EUR</span>
                    </div>
                </div>
                <!-- FIBO2 -->
                <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                    <div style="font-size: 18px; font-weight: 600; color: #10b981; margin-bottom: 4px;">FIBO2</div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Login</span>
                        <span id="mt5-fibo2-login" class="data-value" style="font-size: 18px;">--</span>
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Balance</span>
                        <span id="mt5-fibo2-balance" class="data-value" style="font-size: 18px;">-- EUR</span>
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Equity</span>
                        <span id="mt5-fibo2-equity" class="data-value" style="font-size: 18px;">-- EUR</span>
                    </div>
                </div>
                <!-- FIBO3 -->
                <div style="margin-bottom: 8px;">
                    <div style="font-size: 18px; font-weight: 600; color: #f59e0b; margin-bottom: 4px;">FIBO3
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Login</span>
                        <span id="mt5-fibo3-login" class="data-value" style="font-size: 18px;">--</span>
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Balance</span>
                        <span id="mt5-fibo3-balance" class="data-value" style="font-size: 18px;">-- EUR</span>
                    </div>
                    <div class="data-row" style="padding: 2px 0;">
                        <span class="data-label">Equity</span>
                        <span id="mt5-fibo3-equity" class="data-value" style="font-size: 18px;">-- EUR</span>
                    </div>
                </div>
                <!-- Total -->
                <div style="border-top: 2px solid var(--accent-blue); padding-top: 8px; margin-top: 8px;">
                    <div class="data-row">
                        <span class="data-label" style="font-weight: 700;">TOTAL Balance</span>
                        <span id="mt5-total-balance" class="data-value"
                            style="font-size: 20px; color: var(--accent-blue);">-- EUR</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Positions</span>
                        <span id="position-count" class="data-value">0</span>
                    </div>
                </div>
            </div>

            <!-- Positions -->
            <div class="card section">
                <div class="card-title">Positions Ouvertes (<span id="positions-count">0</span>)</div>
                <div id="positions-container">
                    <div style="color: var(--text-secondary); font-size: 18px; text-align: center; padding: 20px;">
                        Aucune position
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card section">
                <div class="card-title">Dernieres Decisions</div>
                <div id="decisions-log">
                    <div style="color: var(--text-secondary); font-size: 18px; text-align: center; padding: 20px;">
                        Aucune decision
                    </div>
                </div>
            </div>
        </div>

        <!-- Agents Section -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="section-title" style="margin-bottom: 0;">Performances Globales</div>
                <div id="master-pnl-header" style="font-size: 24px; font-weight: 700; color: var(--text-primary);">Total
                    P&L: 0.00 EUR</div>
            </div>

            <!-- MASTER CHART (FULL WIDTH) - CLICKABLE -->
            <div class="card"
                style="margin-bottom: 24px; border-left: 4px solid var(--accent-pink); padding: 20px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                onclick="openGlobalChartModal()"
                title="Cliquer pour voir le graphique detaille avec toutes les courbes">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 20px; font-weight: 600; color: var(--accent-pink);">
                        Performance Globale <span
                            style="font-size: 18px; color: var(--text-secondary); font-weight: 400;">(Cliquer pour
                            agrandir)</span>
                    </div>
                    <div class="chart-legend" style="position: static; background: none; border: none; padding: 0;">
                        <div class="legend-item"><span class="legend-dot"
                                style="background: var(--accent-pink);"></span> Global Closed</div>
                        <div class="legend-item"><span class="legend-dot"
                                style="background: rgba(236,72,153,0.4);"></span> Global Equity</div>
                    </div>
                </div>
                <div style="height: 180px; position: relative;">
                    <canvas id="chart-master" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>

            <div class="section-title">Agents Individuels</div>
            <div class="grid-3">
                <!-- ============ FIBO1 AGENT ============ -->
                <div class="agent-card fibo1">
                    <!-- Performance Chart -->
                    <div class="agent-chart-container" onclick="openChartModal('fibo1')" style="cursor: pointer;"
                        title="Cliquer pour agrandir">
                        <canvas id="chart-fibo1" class="agent-chart"></canvas>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="legend-dot"
                                    style="background: var(--accent-blue);"></span> Ferme</div>
                            <div class="legend-item"><span class="legend-dot"
                                    style="background: rgba(59,130,246,0.4);"></span> Ouvert</div>
                        </div>
                    </div>

                    <div class="agent-header">
                        <span class="agent-name" style="color: var(--accent-blue)">FIBO1</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="fibo1-status" class="agent-status idle">Idle</span>
                            <label class="toggle">
                                <input type="checkbox" id="fibo1-toggle" checked
                                    onchange="toggleAgent('fibo1', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="agent-stats">
                        <div class="stat-item">
                            <div id="fibo1-pnl-closed" class="stat-value">0.00</div>
                            <div class="stat-label">Fermé</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo1-pnl" class="stat-value">0.00</div>
                            <div class="stat-label">Flottant</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo1-trades" class="stat-value">0</div>
                            <div class="stat-label">Trades</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo1-position" class="stat-value">--</div>
                            <div class="stat-label">Position</div>
                        </div>
                    </div>

                    <!-- Log de decisions -->
                    <div class="agent-decision-log"
                        style="margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 18px;">Derniere decision:</span>
                            <span id="fibo1-decision-action"
                                style="font-weight: 600; padding: 4px 10px; border-radius: 4px; background: rgba(148,163,184,0.2); color: var(--text-secondary); font-size: 18px;">--</span>
                        </div>
                        <div id="fibo1-decision-reason"
                            style="color: var(--text-secondary); font-size: 18px; max-height: 60px; overflow-y: auto;">
                            En attente de decision...
                        </div>
                        <div id="fibo1-decision-time"
                            style="color: var(--text-secondary); font-size: 18px; margin-top: 6px; opacity: 0.7;">--
                        </div>
                    </div>

                    <!-- Settings pliable -->
                    <div class="agent-settings">
                        <div class="agent-settings-header" onclick="toggleAgentSettings('fibo1')">
                            <span>Reglages & Compte MT5</span>
                            <span id="fibo1-settings-icon" class="collapsible-icon collapsed">▼</span>
                        </div>
                        <div id="fibo1-settings-content" class="agent-settings-content">
                            <div class="config-grid" style="margin-top: 12px;">
                                <!-- API Configuration -->
                                <div
                                    style="background: rgba(59,130,246,0.1); border: 1px solid #3b82f6; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 18px; color: #3b82f6; font-weight: 600;">API IA</span>
                                        <button class="btn btn-secondary" style="font-size: 18px; padding: 4px 10px;"
                                            onclick="openApiManager()">Gerer</button>
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Cle API</label>
                                        <select id="api-fibo1-key" class="api-key-select" data-agent="fibo1"
                                            onchange="showApiKeyPreview('fibo1')"
                                            style="flex: 1; padding: 10px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                            <option value="">-- Chargement --</option>
                                        </select>
                                    </div>
                                    <div id="api-fibo1-preview"
                                        style="font-size: 18px; color: var(--text-secondary); margin-top: 8px; font-family: monospace; background: var(--bg-dark); padding: 6px 10px; border-radius: 4px;">
                                    </div>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Intervalle (s) <span class="tooltip-icon"
                                            title="Intervalle entre chaque decision de l'agent en secondes. 10 = decision toutes les 10 secondes.">?</span></label>
                                    <input type="number" id="cfg-fibo1-decision_interval" step="5" value="10" min="5"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo1')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Timeframe <span class="tooltip-icon"
                                            title="Timeframe principal pour le signal d'ouverture. M1=1min, M5=5min, M15=15min, etc.">?</span></label>
                                    <select id="cfg-fibo1-signal_timeframe"
                                        style="width: 120px; padding: 10px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"
                                        onchange="saveAgentConfig('fibo1')">
                                        <option value="M1">M1</option>
                                        <option value="M5" selected>M5</option>
                                        <option value="M15">M15</option>
                                        <option value="M30">M30</option>
                                        <option value="H1">H1</option>
                                        <option value="H4">H4</option>
                                    </select>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Niveau Fibo <span class="tooltip-icon"
                                            title="Niveau de retracement Fibonacci cible (0.236, 0.382, 0.5, 0.618, 0.786). 0.236 = retracement faible.">?</span></label>
                                    <select id="cfg-fibo1-fibo_level"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo1')">
                                        <option value="0.236" selected>0.236</option>
                                        <option value="0.382">0.382</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.618">0.618</option>
                                        <option value="0.786">0.786</option>
                                    </select>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Tolerance (%) <span class="tooltip-icon"
                                            title="Distance max en % du prix pour considerer qu'on est sur le niveau Fibo. Plus eleve = plus de trades.">?</span></label>
                                    <input type="number" id="cfg-fibo1-fibo_tolerance_pct" step="0.1" value="1.0"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo1')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Position Size (%) <span class="tooltip-icon"
                                            title="Taille de position en % du capital. 0.01 = 1% du capital par trade.">?</span></label>
                                    <input type="number" id="cfg-fibo1-position_size_pct" step="0.01" value="0.01"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo1')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">WR Min / DD Max <span class="tooltip-icon"
                                            title="Win Rate min et Drawdown max pour auto-stop.">?</span></label>
                                    <span
                                        style="font-size: 18px; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap;">
                                        <input type="number" id="cfg-fibo1-min_winrate_pct" step="5" value="20"
                                            style="width: 70px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentConfig('fibo1')"><span>%</span><span>/</span>
                                        <input type="number" id="cfg-fibo1-max_drawdown_pct" step="0.5" value="5"
                                            style="width: 70px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentConfig('fibo1')"><span>%</span>
                                    </span>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Cooldown (s) <span class="tooltip-icon"
                                            title="Temps d'attente minimum entre 2 trades de cet agent.">?</span></label>
                                    <input type="number" id="cfg-fibo1-cooldown_seconds" step="10" value="60"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo1')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Max Positions <span class="tooltip-icon"
                                            title="Nombre maximum de positions simultanees pour cet agent.">?</span></label>
                                    <input type="number" id="cfg-fibo1-max_positions" min="1" max="10" value="1"
                                        style="width: 80px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo1')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Ajustement <span class="tooltip-icon"
                                            title="Strict: SL/TP fixes, MT5 gere tout. Adjust: l'IA peut repositionner SL/TP des positions en cours.">?</span></label>
                                    <select id="cfg-fibo1-ia_adjust_enabled"
                                        style="padding: 8px 12px; font-size: 18px; border-radius: 8px; background: var(--surface); color: var(--text); border: 1px solid var(--border); cursor: pointer;"
                                        onchange="saveAgentConfig('fibo1')">
                                        <option value="false">&#128274; Strict (pas d'ajustement)</option>
                                        <option value="true">&#9881;&#65039; Adjust (ajustement IA)</option>
                                    </select>
                                </div>
                                <div class="config-row" style="display: none;">
                                    <input type="number" id="cfg-fibo1-min_trades_for_eval" value="10"
                                        onchange="saveAgentConfig('fibo1')">
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 8px 0; padding-top: 8px;">
                                    <div class="config-row">
                                        <label style="font-size: 18px;">MT5 Login</label>
                                        <input type="number" id="acc-fibo1-login"
                                            style="width: 140px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo1')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Server</label>
                                        <input type="text" id="acc-fibo1-server"
                                            style="width: 160px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo1')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Password</label>
                                        <input type="password" id="acc-fibo1-password" placeholder="***"
                                            style="width: 140px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo1')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Terminal MT5</label>
                                        <select id="acc-fibo1-path"
                                            style="width: 200px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo1')">
                                            <option value="C:/Program Files/EightCap MetaTrader 5/terminal64.exe">
                                                EightCap MT5</option>
                                            <option value="C:/Program Files/Fusion Markets MetaTrader 5/terminal64.exe">
                                                Fusion Markets MT5</option>
                                            <option value="C:/Program Files/MetaTrader 5/terminal64.exe">MetaTrader 5
                                            </option>
                                        </select>
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Actif</label>
                                        <label class="toggle" style="transform: scale(0.9);">
                                            <input type="checkbox" id="acc-fibo1-enabled" checked
                                                onchange="saveAgentAccount('fibo1')">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button class="btn btn-primary" style="flex: 1; font-size: 18px; padding: 10px;"
                                        onclick="saveAgentConfig('fibo1'); saveAgentAccount('fibo1');">Sauver</button>
                                    <button class="btn btn-secondary" style="font-size: 18px; padding: 10px;"
                                        onclick="testAgentAccount('fibo1')">Test MT5</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============ FIBO2 AGENT ============ -->
                <div class="agent-card fibo2">
                    <!-- Performance Chart -->
                    <div class="agent-chart-container" onclick="openChartModal('fibo2')" style="cursor: pointer;"
                        title="Cliquer pour agrandir">
                        <canvas id="chart-fibo2" class="agent-chart"></canvas>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="legend-dot"
                                    style="background: var(--accent-green);"></span> Ferme</div>
                            <div class="legend-item"><span class="legend-dot"
                                    style="background: rgba(16,185,129,0.4);"></span> Ouvert</div>
                        </div>
                    </div>

                    <div class="agent-header">
                        <span class="agent-name" style="color: var(--accent-green)">FIBO2</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="fibo2-status" class="agent-status idle">Idle</span>
                            <label class="toggle">
                                <input type="checkbox" id="fibo2-toggle" checked
                                    onchange="toggleAgent('fibo2', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="agent-stats">
                        <div class="stat-item">
                            <div id="fibo2-pnl-closed" class="stat-value">0.00</div>
                            <div class="stat-label">Fermé</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo2-pnl" class="stat-value">0.00</div>
                            <div class="stat-label">Flottant</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo2-trades" class="stat-value">0</div>
                            <div class="stat-label">Trades</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo2-position" class="stat-value">--</div>
                            <div class="stat-label">Position</div>
                        </div>
                    </div>

                    <!-- Log de decisions -->
                    <div class="agent-decision-log"
                        style="margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 18px;">Derniere decision:</span>
                            <span id="fibo2-decision-action"
                                style="font-weight: 600; padding: 4px 10px; border-radius: 4px; background: rgba(148,163,184,0.2); color: var(--text-secondary); font-size: 18px;">--</span>
                        </div>
                        <div id="fibo2-decision-reason"
                            style="color: var(--text-secondary); font-size: 18px; max-height: 60px; overflow-y: auto;">
                            En attente de decision...
                        </div>
                        <div id="fibo2-decision-time"
                            style="color: var(--text-secondary); font-size: 18px; margin-top: 6px; opacity: 0.7;">--
                        </div>
                    </div>

                    <!-- Settings pliable -->
                    <div class="agent-settings">
                        <div class="agent-settings-header" onclick="toggleAgentSettings('fibo2')">
                            <span>Reglages & Compte MT5</span>
                            <span id="fibo2-settings-icon" class="collapsible-icon collapsed">▼</span>
                        </div>
                        <div id="fibo2-settings-content" class="agent-settings-content">
                            <div class="config-grid" style="margin-top: 12px;">
                                <!-- API Configuration -->
                                <div
                                    style="background: rgba(16,185,129,0.1); border: 1px solid #10b981; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 18px; color: #10b981; font-weight: 600;">API IA</span>
                                        <button class="btn btn-secondary" style="font-size: 18px; padding: 4px 10px;"
                                            onclick="openApiManager()">Gerer</button>
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Cle API</label>
                                        <select id="api-fibo2-key" class="api-key-select" data-agent="fibo2"
                                            onchange="showApiKeyPreview('fibo2')"
                                            style="flex: 1; padding: 10px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                            <option value="">-- Chargement --</option>
                                        </select>
                                    </div>
                                    <div id="api-fibo2-preview"
                                        style="font-size: 18px; color: var(--text-secondary); margin-top: 8px; font-family: monospace; background: var(--bg-dark); padding: 6px 10px; border-radius: 4px;">
                                    </div>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Intervalle (s) <span class="tooltip-icon"
                                            title="Intervalle entre chaque decision de l'agent en secondes. 10 = decision toutes les 10 secondes.">?</span></label>
                                    <input type="number" id="cfg-fibo2-decision_interval" step="5" value="10" min="5"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo2')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Timeframe <span class="tooltip-icon"
                                            title="Timeframe principal pour le signal d'ouverture. M1=1min, M5=5min, M15=15min, etc.">?</span></label>
                                    <select id="cfg-fibo2-signal_timeframe"
                                        style="width: 120px; padding: 10px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"
                                        onchange="saveAgentConfig('fibo2')">
                                        <option value="M1">M1</option>
                                        <option value="M5">M5</option>
                                        <option value="M15" selected>M15</option>
                                        <option value="M30">M30</option>
                                        <option value="H1">H1</option>
                                        <option value="H4">H4</option>
                                    </select>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Niveau Fibo <span class="tooltip-icon"
                                            title="Niveau de retracement Fibonacci cible (0.236, 0.382, 0.5, 0.618, 0.786). 0.382 = retracement modere.">?</span></label>
                                    <select id="cfg-fibo2-fibo_level"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo2')">
                                        <option value="0.236">0.236</option>
                                        <option value="0.382" selected>0.382</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.618">0.618</option>
                                        <option value="0.786">0.786</option>
                                    </select>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Tolerance (%) <span class="tooltip-icon"
                                            title="Distance max en % du prix pour considerer qu'on est sur le niveau Fibo. Plus eleve = plus de trades.">?</span></label>
                                    <input type="number" id="cfg-fibo2-fibo_tolerance_pct" step="0.1" value="1.0"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo2')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Position Size (%) <span class="tooltip-icon"
                                            title="Taille de position en % du capital. 0.01 = 1% du capital par trade.">?</span></label>
                                    <input type="number" id="cfg-fibo2-position_size_pct" step="0.01" value="0.01"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo2')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">WR Min / DD Max <span class="tooltip-icon"
                                            title="Win Rate min et Drawdown max pour auto-stop.">?</span></label>
                                    <span
                                        style="font-size: 18px; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap;">
                                        <input type="number" id="cfg-fibo2-min_winrate_pct" step="5" value="20"
                                            style="width: 70px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentConfig('fibo2')"><span>%</span><span>/</span>
                                        <input type="number" id="cfg-fibo2-max_drawdown_pct" step="0.5" value="5"
                                            style="width: 70px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentConfig('fibo2')"><span>%</span>
                                    </span>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Cooldown (s) <span class="tooltip-icon"
                                            title="Temps d'attente minimum entre 2 trades de cet agent.">?</span></label>
                                    <input type="number" id="cfg-fibo2-cooldown_seconds" step="10" value="120"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo2')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Max Positions <span class="tooltip-icon"
                                            title="Nombre maximum de positions simultanees pour cet agent.">?</span></label>
                                    <input type="number" id="cfg-fibo2-max_positions" min="1" max="10" value="1"
                                        style="width: 80px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo2')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Ajustement <span class="tooltip-icon"
                                            title="Strict: SL/TP fixes, MT5 gere tout. Adjust: l'IA peut repositionner SL/TP des positions en cours.">?</span></label>
                                    <select id="cfg-fibo2-ia_adjust_enabled"
                                        style="padding: 8px 12px; font-size: 18px; border-radius: 8px; background: var(--surface); color: var(--text); border: 1px solid var(--border); cursor: pointer;"
                                        onchange="saveAgentConfig('fibo2')">
                                        <option value="false">&#128274; Strict (pas d'ajustement)</option>
                                        <option value="true">&#9881;&#65039; Adjust (ajustement IA)</option>
                                    </select>
                                </div>
                                <div class="config-row" style="display: none;">
                                    <input type="number" id="cfg-fibo2-min_trades_for_eval" value="10"
                                        onchange="saveAgentConfig('fibo2')">
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 8px 0; padding-top: 8px;">
                                    <div class="config-row">
                                        <label style="font-size: 18px;">MT5 Login</label>
                                        <input type="number" id="acc-fibo2-login"
                                            style="width: 140px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo2')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Server</label>
                                        <input type="text" id="acc-fibo2-server"
                                            style="width: 160px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo2')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Password</label>
                                        <input type="password" id="acc-fibo2-password" placeholder="***"
                                            style="width: 140px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo2')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Terminal MT5</label>
                                        <select id="acc-fibo2-path"
                                            style="width: 200px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo2')">
                                            <option value="C:/Program Files/EightCap MetaTrader 5/terminal64.exe">
                                                EightCap MT5</option>
                                            <option value="C:/Program Files/Fusion Markets MetaTrader 5/terminal64.exe">
                                                Fusion Markets MT5</option>
                                            <option value="C:/Program Files/MetaTrader 5/terminal64.exe">MetaTrader 5
                                            </option>
                                        </select>
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Actif</label>
                                        <label class="toggle" style="transform: scale(0.9);">
                                            <input type="checkbox" id="acc-fibo2-enabled"
                                                onchange="saveAgentAccount('fibo2')">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button class="btn btn-primary" style="flex: 1; font-size: 18px; padding: 10px;"
                                        onclick="saveAgentConfig('fibo2'); saveAgentAccount('fibo2');">Sauver</button>
                                    <button class="btn btn-secondary" style="font-size: 18px; padding: 10px;"
                                        onclick="testAgentAccount('fibo2')">Test MT5</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============ FIBO3 AGENT ============ -->
                <div class="agent-card fibo3">
                    <!-- Performance Chart -->
                    <div class="agent-chart-container" onclick="openChartModal('fibo3')" style="cursor: pointer;"
                        title="Cliquer pour agrandir">
                        <canvas id="chart-fibo3" class="agent-chart"></canvas>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="legend-dot"
                                    style="background: var(--accent-orange);"></span> Ferme</div>
                            <div class="legend-item"><span class="legend-dot"
                                    style="background: rgba(245,158,11,0.4);"></span> Ouvert</div>
                        </div>
                    </div>

                    <div class="agent-header">
                        <span class="agent-name" style="color: var(--accent-orange)">FIBO3</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="fibo3-status" class="agent-status idle">Idle</span>
                            <label class="toggle">
                                <input type="checkbox" id="fibo3-toggle" checked
                                    onchange="toggleAgent('fibo3', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="agent-stats">
                        <div class="stat-item">
                            <div id="fibo3-pnl-closed" class="stat-value">0.00</div>
                            <div class="stat-label">Fermé</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo3-pnl" class="stat-value">0.00</div>
                            <div class="stat-label">Flottant</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo3-trades" class="stat-value">0</div>
                            <div class="stat-label">Trades</div>
                        </div>
                        <div class="stat-item">
                            <div id="fibo3-position" class="stat-value">--</div>
                            <div class="stat-label">Position</div>
                        </div>
                    </div>

                    <!-- Log de decisions -->
                    <div class="agent-decision-log"
                        style="margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 18px;">Derniere decision:</span>
                            <span id="fibo3-decision-action"
                                style="font-weight: 600; padding: 4px 10px; border-radius: 4px; background: rgba(148,163,184,0.2); color: var(--text-secondary); font-size: 18px;">--</span>
                        </div>
                        <div id="fibo3-decision-reason"
                            style="color: var(--text-secondary); font-size: 18px; max-height: 60px; overflow-y: auto;">
                            En attente de decision...
                        </div>
                        <div id="fibo3-decision-time"
                            style="color: var(--text-secondary); font-size: 18px; margin-top: 6px; opacity: 0.7;">--
                        </div>
                    </div>

                    <!-- Settings pliable -->
                    <div class="agent-settings">
                        <div class="agent-settings-header" onclick="toggleAgentSettings('fibo3')">
                            <span>Reglages & Compte MT5</span>
                            <span id="fibo3-settings-icon" class="collapsible-icon collapsed">▼</span>
                        </div>
                        <div id="fibo3-settings-content" class="agent-settings-content">
                            <div class="config-grid" style="margin-top: 12px;">
                                <!-- API Configuration -->
                                <div
                                    style="background: rgba(245,158,11,0.1); border: 1px solid #f59e0b; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 18px; color: #f59e0b; font-weight: 600;">API IA</span>
                                        <button class="btn btn-secondary" style="font-size: 18px; padding: 4px 10px;"
                                            onclick="openApiManager()">Gerer</button>
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Cle API</label>
                                        <select id="api-fibo3-key" class="api-key-select" data-agent="fibo3"
                                            onchange="showApiKeyPreview('fibo3')"
                                            style="flex: 1; padding: 10px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                            <option value="">-- Chargement --</option>
                                        </select>
                                    </div>
                                    <div id="api-fibo3-preview"
                                        style="font-size: 18px; color: var(--text-secondary); margin-top: 8px; font-family: monospace; background: var(--bg-dark); padding: 6px 10px; border-radius: 4px;">
                                    </div>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Intervalle (s) <span class="tooltip-icon"
                                            title="Intervalle entre chaque decision de l'agent en secondes. 10 = decision toutes les 10 secondes.">?</span></label>
                                    <input type="number" id="cfg-fibo3-decision_interval" step="5" value="10" min="5"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo3')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Timeframe <span class="tooltip-icon"
                                            title="Timeframe principal pour le signal d'ouverture. M1=1min, M5=5min, M15=15min, etc.">?</span></label>
                                    <select id="cfg-fibo3-signal_timeframe"
                                        style="width: 120px; padding: 10px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"
                                        onchange="saveAgentConfig('fibo3')">
                                        <option value="M1" selected>M1</option>
                                        <option value="M5">M5</option>
                                        <option value="M15">M15</option>
                                        <option value="M30">M30</option>
                                        <option value="H1">H1</option>
                                        <option value="H4">H4</option>
                                    </select>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Niveau Fibo <span class="tooltip-icon"
                                            title="Niveau de retracement Fibonacci cible (0.236, 0.382, 0.5, 0.618, 0.786). 0.618 = Golden Ratio.">?</span></label>
                                    <select id="cfg-fibo3-fibo_level"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo3')">
                                        <option value="0.236">0.236</option>
                                        <option value="0.382">0.382</option>
                                        <option value="0.5">0.5</option>
                                        <option value="0.618" selected>0.618</option>
                                        <option value="0.786">0.786</option>
                                    </select>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Tolerance (%) <span class="tooltip-icon"
                                            title="Distance max en % du prix pour considerer qu'on est sur le niveau Fibo. Plus eleve = plus de trades.">?</span></label>
                                    <input type="number" id="cfg-fibo3-fibo_tolerance_pct" step="0.1" value="1.0"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo3')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Position Size (%) <span class="tooltip-icon"
                                            title="Taille de position en % du capital. 0.01 = 1% du capital par trade.">?</span></label>
                                    <input type="number" id="cfg-fibo3-position_size_pct" step="0.01" value="0.01"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo3')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">WR Min / DD Max <span class="tooltip-icon"
                                            title="Win Rate min et Drawdown max pour auto-stop.">?</span></label>
                                    <span
                                        style="font-size: 18px; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap;">
                                        <input type="number" id="cfg-fibo3-min_winrate_pct" step="5" value="20"
                                            style="width: 70px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentConfig('fibo3')"><span>%</span><span>/</span>
                                        <input type="number" id="cfg-fibo3-max_drawdown_pct" step="0.5" value="5"
                                            style="width: 70px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentConfig('fibo3')"><span>%</span>
                                    </span>
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Cooldown (s) <span class="tooltip-icon"
                                            title="Temps d'attente minimum entre 2 trades de cet agent.">?</span></label>
                                    <input type="number" id="cfg-fibo3-cooldown_seconds" step="10" value="30"
                                        style="width: 120px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo3')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Max Positions <span class="tooltip-icon"
                                            title="Nombre maximum de positions simultanees pour cet agent.">?</span></label>
                                    <input type="number" id="cfg-fibo3-max_positions" min="1" max="10" value="1"
                                        style="width: 80px; padding: 10px; font-size: 18px;"
                                        onchange="saveAgentConfig('fibo3')">
                                </div>
                                <div class="config-row">
                                    <label style="font-size: 18px;">Ajustement <span class="tooltip-icon"
                                            title="Strict: SL/TP fixes, MT5 gere tout. Adjust: l'IA peut repositionner SL/TP des positions en cours.">?</span></label>
                                    <select id="cfg-fibo3-ia_adjust_enabled"
                                        style="padding: 8px 12px; font-size: 18px; border-radius: 8px; background: var(--surface); color: var(--text); border: 1px solid var(--border); cursor: pointer;"
                                        onchange="saveAgentConfig('fibo3')">
                                        <option value="false">&#128274; Strict (pas d'ajustement)</option>
                                        <option value="true">&#9881;&#65039; Adjust (ajustement IA)</option>
                                    </select>
                                </div>
                                <div class="config-row" style="display: none;">
                                    <input type="number" id="cfg-fibo3-min_trades_for_eval" value="10"
                                        onchange="saveAgentConfig('fibo3')">
                                </div>
                                <div style="border-top: 1px solid var(--border); margin: 8px 0; padding-top: 8px;">
                                    <div class="config-row">
                                        <label style="font-size: 18px;">MT5 Login</label>
                                        <input type="number" id="acc-fibo3-login"
                                            style="width: 140px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo3')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Server</label>
                                        <input type="text" id="acc-fibo3-server"
                                            style="width: 160px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo3')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Password</label>
                                        <input type="password" id="acc-fibo3-password" placeholder="***"
                                            style="width: 140px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo3')">
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Terminal MT5</label>
                                        <select id="acc-fibo3-path"
                                            style="width: 200px; padding: 10px; font-size: 18px;"
                                            onchange="saveAgentAccount('fibo3')">
                                            <option value="C:/Program Files/EightCap MetaTrader 5/terminal64.exe">
                                                EightCap MT5</option>
                                            <option value="C:/Program Files/Fusion Markets MetaTrader 5/terminal64.exe">
                                                Fusion Markets MT5</option>
                                            <option value="C:/Program Files/MetaTrader 5/terminal64.exe">MetaTrader 5
                                            </option>
                                        </select>
                                    </div>
                                    <div class="config-row">
                                        <label style="font-size: 18px;">Actif</label>
                                        <label class="toggle" style="transform: scale(0.9);">
                                            <input type="checkbox" id="acc-fibo3-enabled"
                                                onchange="saveAgentAccount('fibo3')">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button class="btn btn-primary" style="flex: 1; font-size: 18px; padding: 10px;"
                                        onclick="saveAgentConfig('fibo3'); saveAgentAccount('fibo3');">Sauver</button>
                                    <button class="btn btn-secondary" style="font-size: 18px; padding: 10px;"
                                        onclick="testAgentAccount('fibo3')">Test MT5</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="section">
            <div class="section-title">Stat Session</div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Trades</th>
                            <th>Wins</th>
                            <th>Losses</th>
                            <th>Win Rate</th>
                            <th>P&L Total</th>
                            <th>Moy/Trade</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table">
                        <tr>
                            <td colspan="9" style="text-align: center; color: var(--text-secondary);">
                                Chargement...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ================================================================
             SECTION LABORATOIRE - REGLAGES (PLIABLE)
             ================================================================ -->
        <div class="section">
            <div class="section-title collapsible"
                style="color: var(--accent-purple); cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                onclick="toggleLaboratory()">
                <span>LABORATOIRE - Risque & TP/SL</span>
                <span id="lab-toggle-icon" style="font-size: 24px; transition: transform 0.3s;">▼</span>
            </div>

            <div id="laboratory-content" class="laboratory-content" style="display: none;">

                <!-- LIGNE 1: Risque + TP/SL + Trailing + Session + Strategist (5 colonnes) -->
                <div
                    style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-top: 20px; align-items: stretch;">

                    <!-- 1. RISQUE -->
                    <div class="card"
                        style="border-left: 4px solid var(--accent-red); padding: 16px; display: flex; flex-direction: column;">
                        <div class="card-title" style="color: var(--accent-red); font-size: 18px; margin-bottom: 12px;">
                            Risque</div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Max Drawdown <span class="tooltip-icon"
                                    title="Perte max avant arret automatique">?</span></label>
                            <input type="number" id="cfg-risk-max_drawdown_pct" step="1" value="10"
                                style="width: 100px; font-size: 18px;" onchange="saveRiskConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Perte Jour Max</label>
                            <input type="number" id="cfg-risk-max_daily_loss_pct" step="1" value="5"
                                style="width: 100px; font-size: 18px;" onchange="saveRiskConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Max Positions</label>
                            <input type="number" id="cfg-risk-max_positions_total" step="1" value="3"
                                style="width: 100px; font-size: 18px;" onchange="saveRiskConfig()">
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Urgence</label>
                            <input type="number" id="cfg-risk-emergency_close_pct" step="1" value="15"
                                style="width: 100px; font-size: 18px;" onchange="saveRiskConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Winner Never Loser <span class="tooltip-icon"
                                    title="Ne jamais laisser un trade gagnant devenir perdant">?</span></label>
                            <label class="toggle" style="transform: scale(0.85);">
                                <input type="checkbox" id="cfg-risk-winner_never_loser" checked
                                    onchange="saveRiskConfig()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="flex-grow: 1;"></div>
                        <button class="btn btn-danger" style="width: 100%; font-size: 18px; padding: 8px;"
                            onclick="saveRiskConfig()">Appliquer</button>
                    </div>

                    <!-- 2. TP/SL -->
                    <div class="card"
                        style="border-left: 4px solid var(--accent-purple); padding: 16px; display: flex; flex-direction: column;">
                        <div class="card-title"
                            style="color: var(--accent-purple); font-size: 18px; margin-bottom: 12px;">TP/SL (% Capital)
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Take Profit</label>
                            <input type="number" id="cfg-spread-tp_pct" step="0.05" value="0.3"
                                style="width: 80px; font-size: 18px;" onchange="saveSpreadConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Stop Loss</label>
                            <input type="number" id="cfg-spread-sl_pct" step="0.05" value="0.5"
                                style="width: 80px; font-size: 18px;" onchange="saveSpreadConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Max Spread <span class="tooltip-icon"
                                    title="Spread max pour ouvrir une position. Au dela, on attend.">?</span></label>
                            <input type="number" id="cfg-spread-max_spread_points" step="100" value="2000"
                                style="width: 80px; font-size: 18px;" onchange="saveSpreadConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">pts</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Spread Check <span class="tooltip-icon"
                                    title="Activer/desactiver la verification du spread avant d'ouvrir">?</span></label>
                            <label class="toggle" style="transform: scale(0.85);">
                                <input type="checkbox" id="cfg-spread-spread_check_enabled" checked
                                    onchange="saveSpreadConfig()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <!-- Spread Actuel / Min / Max -->
                        <div
                            style="background: rgba(139,92,246,0.1); border-radius: 6px; padding: 8px; margin-top: 8px;">
                            <div
                                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                                <div>
                                    <div style="font-size: 18px; color: var(--text-secondary);">Actuel</div>
                                    <div id="spread-current"
                                        style="font-size: 18px; font-weight: 700; color: var(--accent-blue);">--</div>
                                </div>
                                <div>
                                    <div style="font-size: 18px; color: var(--text-secondary);">Min</div>
                                    <div id="spread-min"
                                        style="font-size: 18px; font-weight: 700; color: var(--accent-green);">--</div>
                                </div>
                                <div>
                                    <div style="font-size: 18px; color: var(--text-secondary);">Max</div>
                                    <div id="spread-max"
                                        style="font-size: 18px; font-weight: 700; color: var(--accent-red);">--</div>
                                </div>
                            </div>
                        </div>
                        <div style="flex-grow: 1;"></div>
                        <button class="btn btn-secondary" style="width: 100%; font-size: 18px; padding: 8px;"
                            onclick="saveSpreadConfig()">Appliquer</button>
                    </div>

                    <!-- 3. TRAILING & BE -->
                    <div class="card"
                        style="border-left: 4px solid var(--accent-green); padding: 16px; display: flex; flex-direction: column;">
                        <div class="card-title"
                            style="color: var(--accent-green); font-size: 18px; margin-bottom: 12px;">Trailing & Break
                            Even</div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Trailing Stop</label>
                            <label class="toggle" style="transform: scale(0.85);">
                                <input type="checkbox" id="cfg-spread-trailing_enabled" checked
                                    onchange="saveSpreadConfig()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Trailing Start <span class="tooltip-icon"
                                    title="Activer trailing apres ce % de profit">?</span></label>
                            <input type="number" id="cfg-spread-trailing_start_pct" step="0.05" value="0.2"
                                style="width: 80px; font-size: 18px;" onchange="saveSpreadConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">Trailing Distance</label>
                            <input type="number" id="cfg-spread-trailing_distance_pct" step="0.05" value="0.1"
                                style="width: 80px; font-size: 18px;" onchange="saveSpreadConfig()">
                            <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                        </div>
                        <div style="border-top: 1px solid var(--border); margin: 10px 0; padding-top: 10px;">
                            <div class="config-row" style="margin-bottom: 8px;">
                                <label style="font-size: 18px;">Break Even</label>
                                <label class="toggle" style="transform: scale(0.85);">
                                    <input type="checkbox" id="cfg-spread-break_even_enabled" checked
                                        onchange="saveSpreadConfig()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="config-row">
                                <label style="font-size: 18px;">BE Activation <span class="tooltip-icon"
                                        title="Passer en break even apres ce % de profit">?</span></label>
                                <input type="number" id="cfg-spread-break_even_pct" step="0.05" value="0.15"
                                    style="width: 80px; font-size: 18px;" onchange="saveSpreadConfig()">
                                <span style="font-size: 18px; color: var(--text-secondary);">%</span>
                            </div>
                        </div>
                        <div style="flex-grow: 1;"></div>
                        <button class="btn btn-success" style="width: 100%; font-size: 18px; padding: 8px;"
                            onclick="saveTrailingConfig()">Appliquer</button>
                    </div>

                    <!-- 4. SESSION -->
                    <div class="card"
                        style="border-left: 4px solid #ec4899; padding: 16px; display: flex; flex-direction: column;">
                        <div class="card-title" style="color: #ec4899; font-size: 18px; margin-bottom: 12px;">Session
                            G13
                        </div>
                        <div class="config-row" style="margin-bottom: 6px;">
                            <label style="font-size: 18px;">Session</label>
                            <span id="current-session-id" class="data-value" style="font-size: 18px;">--</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 6px;">
                            <label style="font-size: 18px;">Debut</label>
                            <span id="session-start-time" class="data-value" style="font-size: 18px;">--</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 6px;">
                            <label style="font-size: 18px;">Trades</label>
                            <span id="session-trades-count" class="data-value" style="font-size: 18px;">0</span>
                        </div>
                        <div class="config-row" style="margin-bottom: 8px;">
                            <label style="font-size: 18px;">P&L</label>
                            <span id="session-pnl-value" class="data-value" style="font-size: 18px;">0.00 EUR</span>
                        </div>

                        <!-- Sessions de Marché (Killzones) -->
                        <div style="font-size: 18px; color: var(--text-secondary); margin-bottom: 8px;">Sessions de
                            Marché</div>
                        <div class="killzone-container">
                            <div id="kz-asia" class="killzone-item" style="color: #60a5fa;">
                                <div class="killzone-dot"></div>
                                <span class="killzone-label">ASIE</span>
                            </div>
                            <div id="kz-london" class="killzone-item" style="color: #4ade80;">
                                <div class="killzone-dot"></div>
                                <span class="killzone-label">LDN</span>
                            </div>
                            <div id="kz-overlap" class="killzone-item" style="color: #f472b6;">
                                <div class="killzone-dot"></div>
                                <span class="killzone-label">KILLZONE</span>
                            </div>
                            <div id="kz-usa" class="killzone-item" style="color: #fb923c;">
                                <div class="killzone-dot"></div>
                                <span class="killzone-label">NY</span>
                            </div>
                        </div>
                        <div style="flex-grow: 1;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success" style="flex: 1; font-size: 18px; padding: 8px;"
                                onclick="startNewSession()"
                                title="Ferme la session actuelle, sauvegarde les logs, et demarre une nouvelle session">Nouvelle
                                Session</button>
                            <button class="btn btn-danger" style="font-size: 18px; padding: 8px;" onclick="endSession()"
                                title="Termine la session actuelle et sauvegarde les logs (sans en creer une nouvelle)">Fin</button>
                        </div>
                    </div>

                    <!-- 5. STRATEGIST -->
                    <div class="card"
                        style="border-left: 4px solid var(--accent-orange); padding: 16px; display: flex; flex-direction: column;">
                        <div class="card-title"
                            style="color: var(--accent-orange); font-size: 18px; margin-bottom: 8px;">Strategist IA
                        </div>
                        <!-- API Selector -->
                        <div style="margin-bottom: 10px;">
                            <select id="api-strategist-key" class="api-key-select" data-agent="strategist"
                                onchange="showApiKeyPreview('strategist')"
                                style="width: 100%; padding: 8px; font-size: 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="">-- Cle API --</option>
                            </select>
                            <div id="api-strategist-preview"
                                style="font-size: 18px; color: var(--text-secondary); margin-top: 4px; font-family: monospace;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div>
                                <div style="font-size: 18px; color: var(--text-secondary);">Win Rate</div>
                                <div id="strategist-winrate" style="font-size: 18px; font-weight: 600;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 18px; color: var(--text-secondary);">Tendance</div>
                                <div id="strategist-trend" style="font-size: 18px; font-weight: 600;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 18px; color: var(--text-secondary);">Meilleur</div>
                                <div id="strategist-best" style="font-size: 18px; color: var(--accent-green);">--</div>
                            </div>
                            <div>
                                <div style="font-size: 18px; color: var(--text-secondary);">Pire</div>
                                <div id="strategist-worst" style="font-size: 18px; color: var(--accent-red);">--</div>
                            </div>
                        </div>
                        <div style="flex-grow: 1;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" style="flex: 1; font-size: 18px; padding: 8px;"
                                onclick="loadStrategistInsights()">Analyser</button>
                            <button class="btn btn-secondary" style="font-size: 18px; padding: 8px;"
                                onclick="showStrategistLogs()">Logs</button>
                        </div>
                    </div>
                </div>

                <!-- LIGNE 2: Actions Rapides -->
                <div style="margin-top: 16px;">
                    <div class="card"
                        style="padding: 16px; background: linear-gradient(135deg, var(--bg-card) 0%, rgba(139, 92, 246, 0.1) 100%);">
                        <div class="card-title" style="font-size: 18px; margin-bottom: 12px;">Actions Rapides</div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" style="font-size: 18px; padding: 10px 16px;"
                                onclick="loadAllConfigs()">Recharger Configs</button>
                            <button class="btn btn-secondary" style="font-size: 18px; padding: 10px 16px;"
                                onclick="resetToDefaults()">Reset Defaut</button>
                            <button class="btn btn-success" style="font-size: 18px; padding: 10px 16px;"
                                onclick="saveAllConfigs()">Sauvegarder TOUT</button>
                            <button class="btn btn-danger" style="font-size: 18px; padding: 10px 16px;"
                                onclick="exportConfig()">Exporter JSON</button>
                            <button class="btn btn-secondary" style="font-size: 18px; padding: 10px 16px;"
                                onclick="exportSessionLog()">Exporter Logs</button>
                            <button class="btn btn-primary" style="font-size: 18px; padding: 10px 16px; background: #6366f1;"
                                onclick="syncMT5Trades()">Sync MT5</button>
                            <button class="btn btn-warning" style="font-size: 18px; padding: 10px 16px;"
                                onclick="validatePositions()">Valider Positions</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Configuration API
            const API_URL = ''; // Meme origine que le backend

            // Refresh interval
            let refreshInterval = null;

            // Spread tracking (min/max depuis demarrage frontend)
            let spreadMin = null;
            let spreadMax = null;

            // Toggle LABORATOIRE section
            function toggleLaboratory() {
                const content = document.getElementById('laboratory-content');
                const icon = document.getElementById('lab-toggle-icon');

                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                }
            }

            // Toggle collapsible sections (market data, etc.)
            function toggleSection(sectionId) {
                const content = document.getElementById(`${sectionId}-content`);
                const icon = document.getElementById(`${sectionId}-icon`);

                content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            }

            // Toggle agent settings
            function toggleAgentSettings(agentId) {
                const content = document.getElementById(`${agentId}-settings-content`);
                const icon = document.getElementById(`${agentId}-settings-icon`);

                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.add('collapsed');
                } else {
                    content.classList.add('expanded');
                    icon.classList.remove('collapsed');
                }
            }

            // ============================================
            // CHARTS DE PERFORMANCE PAR AGENT
            // ============================================
            const agentCharts = {
                fibo1: { closed: [], open: [], timestamps: [], sessionStart: null },
                fibo2: { closed: [], open: [], timestamps: [], sessionStart: null },
                fibo3: { closed: [], open: [], timestamps: [], sessionStart: null },
                master: { closed: [], open: [], timestamps: [], sessionStart: null }
            };

            // Agent actuellement affiche dans le modal
            let currentChartModalAgent = null;

            // Couleurs des agents
            const agentColors = {
                fibo1: { main: '#3b82f6', light: 'rgba(59,130,246,0.4)' },
                fibo2: { main: '#10b981', light: 'rgba(16,185,129,0.4)' },
                fibo3: { main: '#ec4899', light: 'rgba(236,72,153,0.4)' },
                master: { main: '#ffffff', light: 'rgba(255,255,255,0.4)' }
            };

            // Dessiner le graphique d'un agent
            function drawAgentChart(agentId) {
                const canvas = document.getElementById(`chart-${agentId}`);
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const rect = canvas.parentElement.getBoundingClientRect();

                // Ajuster la taille du canvas
                canvas.width = rect.width - 16;
                canvas.height = rect.height - 16;

                const data = agentCharts[agentId];
                const colors = agentColors[agentId];

                // Marges pour les axes
                const marginLeft = 50;   // Espace pour labels Y
                const marginRight = 10;  // Petit espace a droite
                const marginTop = 10;
                const marginBottom = 20; // Espace pour labels X

                const chartWidth = canvas.width - marginLeft - marginRight;
                const chartHeight = canvas.height - marginTop - marginBottom;

                // Effacer
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Style des labels
                ctx.font = '12px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';

                // Si pas de donnees, afficher ligne a zero
                if (data.closed.length === 0) {
                    // Ligne zero
                    const zeroY = marginTop + chartHeight / 2;
                    ctx.strokeStyle = colors.main;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(marginLeft, zeroY);
                    ctx.lineTo(marginLeft + chartWidth, zeroY);
                    ctx.stroke();
                    // Label zero
                    ctx.textAlign = 'right';
                    ctx.fillText('0 EUR', marginLeft - 5, zeroY + 4);
                    return;
                }

                // Calculer les min/max pour l'echelle
                const allValues = [...data.closed, ...data.open];
                const minVal = Math.min(0, ...allValues);
                const maxVal = Math.max(0, ...allValues);
                const range = Math.max(0.1, maxVal - minVal);
                const padding = range * 0.15;

                // Fonction pour convertir valeur en Y
                const valueToY = (val) => {
                    return marginTop + chartHeight - ((val - minVal + padding) / (range + 2 * padding)) * chartHeight;
                };

                // Calculer la largeur par point (compression horizontale automatique)
                const numPoints = Math.max(data.closed.length, data.open.length, 1);
                const stepX = chartWidth / Math.max(numPoints - 1, 1);

                // Dessiner les labels Y (min, 0, max)
                ctx.textAlign = 'right';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';

                // Max
                const maxY = valueToY(maxVal);
                ctx.fillText(`${maxVal.toFixed(2)}`, marginLeft - 5, maxY + 4);

                // Min
                const minY = valueToY(minVal);
                ctx.fillText(`${minVal.toFixed(2)}`, marginLeft - 5, minY + 4);

                // Zero (si different de min et max)
                if (minVal < 0 && maxVal > 0) {
                    const zeroY = valueToY(0);
                    ctx.fillText('0', marginLeft - 5, zeroY + 4);
                }

                // Ligne zero
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(marginLeft, valueToY(0));
                ctx.lineTo(marginLeft + chartWidth, valueToY(0));
                ctx.stroke();
                ctx.setLineDash([]);

                // Grille horizontale legere
                ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(marginLeft, maxY);
                ctx.lineTo(marginLeft + chartWidth, maxY);
                ctx.moveTo(marginLeft, minY);
                ctx.lineTo(marginLeft + chartWidth, minY);
                ctx.stroke();

                // Dessiner courbe fermee (cumul positions fermees)
                if (data.closed.length > 0) {
                    ctx.strokeStyle = colors.main;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    data.closed.forEach((val, i) => {
                        const x = marginLeft + i * stepX;
                        const y = valueToY(val);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();

                    // Point final
                    const lastX = marginLeft + (data.closed.length - 1) * stepX;
                    const lastY = valueToY(data.closed[data.closed.length - 1]);
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
                    ctx.fillStyle = colors.main;
                    ctx.fill();
                }

                // Dessiner courbe ouverte (cumul positions ouvertes)
                if (data.open.length > 0) {
                    ctx.strokeStyle = colors.light;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 2]);
                    ctx.beginPath();
                    data.open.forEach((val, i) => {
                        const x = marginLeft + i * stepX;
                        const y = valueToY(val);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // Label nombre de points (en bas a droite)
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.textAlign = 'right';
                ctx.fillText(`${numPoints} pts`, marginLeft + chartWidth, canvas.height - 2);
            }

            // Ajouter un point aux graphiques
            function updateAgentChartData(agentId, closedPnl, openPnl) {
                const data = agentCharts[agentId];

                // Initialiser sessionStart si premier point
                if (!data.sessionStart) {
                    data.sessionStart = new Date();
                }

                data.closed.push(closedPnl);
                data.open.push(closedPnl + openPnl); // Open = closed + unrealized
                data.timestamps.push(new Date());

                // Limiter a 500 points max pour le detail (se contracte automatiquement)
                if (data.closed.length > 500) {
                    data.closed.shift();
                    data.open.shift();
                    data.timestamps.shift();
                }

                drawAgentChart(agentId);

                // Si le modal est ouvert pour cet agent, redessiner aussi
                if (currentChartModalAgent === agentId) {
                    drawDetailedChart(agentId);
                }

                // Si le modal global est ouvert et qu'on a mis a jour master, redessiner
                if (globalChartModalOpen && agentId === 'master') {
                    drawGlobalDetailedChart();
                }
            }

            // Reset des graphiques (nouvelle session)
            // Reset des graphiques (nouvelle session)
            function resetAgentCharts() {
                ['fibo1', 'fibo2', 'fibo3', 'master'].forEach(agentId => {
                    agentCharts[agentId] = { closed: [], open: [], timestamps: [], sessionStart: new Date() };
                    drawAgentChart(agentId);
                });
            }

            // Dessiner tous les graphiques
            function drawAllCharts() {
                ['fibo1', 'fibo2', 'fibo3', 'master'].forEach(drawAgentChart);
            }

            // ============================================
            // MODAL GRAPHIQUE DETAILLE
            // ============================================

            function openChartModal(agentId) {
                currentChartModalAgent = agentId;
                const modal = document.getElementById('chart-detail-modal');
                const data = agentCharts[agentId];
                const colors = agentColors[agentId];

                // Mettre a jour le titre
                const agentNames = { fibo1: 'FIBO1', fibo2: 'FIBO2', fibo3: 'FIBO3' };
                document.getElementById('chart-modal-title').textContent = `Courbe d'Equite - ${agentNames[agentId]}`;

                // Calculer la duree de session
                let sessionDuration = 'Session en cours';
                if (data.sessionStart) {
                    const now = new Date();
                    const diffMs = now - data.sessionStart;
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    sessionDuration = `Session demarree il y a ${hours}h ${minutes}min - ${data.closed.length} points enregistres`;
                }
                document.getElementById('chart-modal-subtitle').textContent = sessionDuration;

                // Calculer les stats
                const lastClosed = data.closed.length > 0 ? data.closed[data.closed.length - 1] : 0;
                const lastOpen = data.open.length > 0 ? data.open[data.open.length - 1] : 0;
                const openPnl = lastOpen - lastClosed;
                const maxProfit = data.open.length > 0 ? Math.max(...data.open) : 0;
                const minProfit = data.open.length > 0 ? Math.min(...data.open) : 0;

                // Formatter les valeurs
                const formatVal = (val) => {
                    const sign = val >= 0 ? '+' : '';
                    return `${sign}${val.toFixed(2)} EUR`;
                };

                document.getElementById('chart-stat-closed').textContent = formatVal(lastClosed);
                document.getElementById('chart-stat-closed').style.color = lastClosed >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                document.getElementById('chart-stat-open').textContent = formatVal(openPnl);
                document.getElementById('chart-stat-open').style.color = openPnl >= 0 ? 'var(--accent-blue)' : 'var(--accent-red)';

                document.getElementById('chart-stat-total').textContent = formatVal(lastOpen);
                document.getElementById('chart-stat-total').style.color = lastOpen >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                document.getElementById('chart-stat-max').textContent = formatVal(maxProfit);
                document.getElementById('chart-stat-max').style.color = 'var(--accent-green)';

                document.getElementById('chart-stat-min').textContent = formatVal(minProfit);
                document.getElementById('chart-stat-min').style.color = minProfit < 0 ? 'var(--accent-red)' : 'var(--text-secondary)';

                document.getElementById('chart-stat-points').textContent = data.closed.length;

                // Mettre a jour les couleurs de la legende
                document.getElementById('legend-closed-color').style.background = colors.main;
                document.getElementById('legend-open-color').style.background = colors.main;

                // Afficher le modal
                modal.style.display = 'flex';

                // Dessiner le graphique detaille (apres un court delai pour laisser le modal se rendre)
                setTimeout(() => drawDetailedChart(agentId), 50);
            }

            function closeChartModal() {
                currentChartModalAgent = null;
                document.getElementById('chart-detail-modal').style.display = 'none';
            }

            function drawDetailedChart(agentId) {
                const canvas = document.getElementById('chart-detail-canvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;

                // Ajuster la taille du canvas a son container
                canvas.width = container.clientWidth - 40;
                canvas.height = container.clientHeight - 40;

                const data = agentCharts[agentId];
                const colors = agentColors[agentId];

                // Marges pour les axes (marginRight augmente pour afficher la valeur finale)
                const marginLeft = 80;
                const marginRight = 120;
                const marginTop = 30;
                const marginBottom = 60;

                const chartWidth = canvas.width - marginLeft - marginRight;
                const chartHeight = canvas.height - marginTop - marginBottom;

                // Effacer
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Fond
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(marginLeft, marginTop, chartWidth, chartHeight);

                // Style des labels
                ctx.font = '14px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';

                // Si pas de donnees
                if (data.closed.length === 0) {
                    ctx.textAlign = 'center';
                    ctx.font = '18px Arial';
                    ctx.fillText('Aucune donnee - En attente de trades', canvas.width / 2, canvas.height / 2);
                    return;
                }

                // Calculer les min/max pour l'echelle
                const allValues = [...data.closed, ...data.open];
                const minVal = Math.min(0, ...allValues);
                const maxVal = Math.max(0, ...allValues);
                const range = Math.max(0.1, maxVal - minVal);
                const padding = range * 0.1;

                // Fonction pour convertir valeur en Y
                const valueToY = (val) => {
                    return marginTop + chartHeight - ((val - minVal + padding) / (range + 2 * padding)) * chartHeight;
                };

                // Calculer la largeur par point
                const numPoints = data.closed.length;
                const stepX = chartWidth / Math.max(numPoints - 1, 1);

                // Grille horizontale
                ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                ctx.lineWidth = 1;
                const gridLines = 5;
                for (let i = 0; i <= gridLines; i++) {
                    const val = minVal + (range * i / gridLines);
                    const y = valueToY(val);
                    ctx.beginPath();
                    ctx.moveTo(marginLeft, y);
                    ctx.lineTo(marginLeft + chartWidth, y);
                    ctx.stroke();

                    // Labels Y
                    ctx.textAlign = 'right';
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.fillText(`${val.toFixed(2)} EUR`, marginLeft - 10, y + 4);
                }

                // Ligne zero (plus visible)
                const zeroY = valueToY(0);
                ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 4]);
                ctx.beginPath();
                ctx.moveTo(marginLeft, zeroY);
                ctx.lineTo(marginLeft + chartWidth, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);

                // Labels X (timestamps)
                ctx.textAlign = 'center';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                const xLabelsCount = Math.min(10, numPoints);
                const xLabelStep = Math.floor(numPoints / xLabelsCount) || 1;
                for (let i = 0; i < numPoints; i += xLabelStep) {
                    const x = marginLeft + i * stepX;
                    const timestamp = data.timestamps[i];
                    if (timestamp) {
                        const time = timestamp.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        ctx.fillText(time, x, canvas.height - marginBottom + 20);
                    }
                }

                // Dessiner aire sous la courbe closed (gradient)
                const gradient = ctx.createLinearGradient(0, marginTop, 0, marginTop + chartHeight);
                gradient.addColorStop(0, colors.light);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');

                ctx.beginPath();
                ctx.moveTo(marginLeft, zeroY);
                data.closed.forEach((val, i) => {
                    const x = marginLeft + i * stepX;
                    const y = valueToY(val);
                    ctx.lineTo(x, y);
                });
                ctx.lineTo(marginLeft + (numPoints - 1) * stepX, zeroY);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();

                // Dessiner courbe closed (P&L positions fermees)
                ctx.strokeStyle = colors.main;
                ctx.lineWidth = 3;
                ctx.beginPath();
                data.closed.forEach((val, i) => {
                    const x = marginLeft + i * stepX;
                    const y = valueToY(val);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Points sur la courbe closed
                data.closed.forEach((val, i) => {
                    // Ne dessiner que certains points pour lisibilite
                    if (numPoints <= 50 || i % Math.ceil(numPoints / 50) === 0 || i === numPoints - 1) {
                        const x = marginLeft + i * stepX;
                        const y = valueToY(val);
                        ctx.beginPath();
                        ctx.arc(x, y, 4, 0, Math.PI * 2);
                        ctx.fillStyle = colors.main;
                        ctx.fill();
                    }
                });

                // Dessiner courbe open (P&L total)
                ctx.strokeStyle = colors.light;
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 3]);
                ctx.beginPath();
                data.open.forEach((val, i) => {
                    const x = marginLeft + i * stepX;
                    const y = valueToY(val);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);

                // Point final sur courbe closed (plus gros)
                const lastX = marginLeft + (numPoints - 1) * stepX;
                const lastY = valueToY(data.closed[numPoints - 1]);
                ctx.beginPath();
                ctx.arc(lastX, lastY, 8, 0, Math.PI * 2);
                ctx.fillStyle = colors.main;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Valeur finale affichee
                ctx.textAlign = 'left';
                ctx.font = 'bold 18px Arial';
                ctx.fillStyle = data.closed[numPoints - 1] >= 0 ? '#10b981' : '#ef4444';
                const finalVal = data.closed[numPoints - 1];
                ctx.fillText(`${finalVal >= 0 ? '+' : ''}${finalVal.toFixed(2)} EUR`, lastX + 15, lastY + 5);

                // Ajouter les event listeners pour le tooltip
                setupChartTooltip(canvas, agentId, marginLeft, marginRight, marginTop, marginBottom, stepX, valueToY);
            }

            function setupChartTooltip(canvas, agentId, marginLeft, marginRight, marginTop, marginBottom, stepX, valueToY) {
                const tooltip = document.getElementById('chart-tooltip');
                const data = agentCharts[agentId];

                // Supprimer les anciens listeners
                canvas.onmousemove = null;
                canvas.onmouseleave = null;

                canvas.onmousemove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    // Verifier si on est dans la zone du graphique
                    const chartWidth = canvas.width - marginLeft - marginRight;
                    if (x < marginLeft || x > marginLeft + chartWidth) {
                        tooltip.style.display = 'none';
                        return;
                    }

                    // Trouver l'index du point le plus proche
                    const relativeX = x - marginLeft;
                    const index = Math.round(relativeX / stepX);

                    if (index >= 0 && index < data.closed.length) {
                        const closedVal = data.closed[index];
                        const openVal = data.open[index];
                        const timestamp = data.timestamps[index];

                        // Formater le temps
                        const timeStr = timestamp ? timestamp.toLocaleString('fr-FR', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        }) : 'N/A';

                        document.getElementById('tooltip-time').textContent = `Point ${index + 1} - ${timeStr}`;

                        const formatVal = (val) => `${val >= 0 ? '+' : ''}${val.toFixed(2)} EUR`;

                        document.getElementById('tooltip-closed').textContent = formatVal(closedVal);
                        document.getElementById('tooltip-closed').style.color = closedVal >= 0 ? '#10b981' : '#ef4444';

                        document.getElementById('tooltip-open').textContent = formatVal(openVal);
                        document.getElementById('tooltip-open').style.color = openVal >= 0 ? '#10b981' : '#ef4444';

                        // Positionner le tooltip
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${x + 20}px`;
                        tooltip.style.top = `${y - 30}px`;

                        // Eviter de sortir du container
                        const tooltipRect = tooltip.getBoundingClientRect();
                        const containerRect = canvas.parentElement.getBoundingClientRect();
                        if (tooltipRect.right > containerRect.right) {
                            tooltip.style.left = `${x - tooltipRect.width - 20}px`;
                        }
                    } else {
                        tooltip.style.display = 'none';
                    }
                };

                canvas.onmouseleave = () => {
                    tooltip.style.display = 'none';
                };
            }

            function exportChartData() {
                if (!currentChartModalAgent) return;

                const agentId = currentChartModalAgent;
                const data = agentCharts[agentId];

                if (data.closed.length === 0) {
                    alert('Aucune donnee a exporter');
                    return;
                }

                // Creer le contenu CSV
                let csv = 'Index,Timestamp,P&L Ferme (EUR),P&L Total (EUR),P&L Ouvert (EUR)\n';

                data.closed.forEach((closedVal, i) => {
                    const openVal = data.open[i] || 0;
                    const unrealizedVal = openVal - closedVal;
                    const timestamp = data.timestamps[i] ? data.timestamps[i].toISOString() : '';

                    csv += `${i + 1},${timestamp},${closedVal.toFixed(2)},${openVal.toFixed(2)},${unrealizedVal.toFixed(2)}\n`;
                });

                // Telecharger le fichier
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `equity_${agentId}_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // ============================================
            // MODAL GRAPHIQUE GLOBAL (6 COURBES)
            // ============================================

            // Donnees pour le graphique global
            let globalChartData = {
                timestamps: [],
                global: [],        // P&L Global Total (closed + open)
                fibo1: [],      // P&L FIBO1
                fibo2: [],          // P&L FIBO2
                fibo3: [],   // P&L FIBO3
                floating: [],      // P&L Flottant total
                session: [],       // P&L Session (realise)
                sessionStart: null
            };

            let globalChartModalOpen = false;

            // Visibilite des courbes (true = visible)
            let globalCurveVisibility = {
                global: true,
                fibo1: true,
                fibo2: true,
                fibo3: true,
                floating: true,
                session: true
            };

            // Toggle la visibilite d'une courbe
            function toggleGlobalCurve(curveId) {
                globalCurveVisibility[curveId] = !globalCurveVisibility[curveId];

                // Mettre a jour le style visuel de la legende et des stats
                const legendEl = document.getElementById(`legend-${curveId}`);
                const statEl = document.getElementById(`stat-${curveId}`);

                if (globalCurveVisibility[curveId]) {
                    // Courbe visible
                    if (legendEl) legendEl.style.opacity = '1';
                    if (statEl) statEl.style.opacity = '1';
                } else {
                    // Courbe cachee
                    if (legendEl) legendEl.style.opacity = '0.3';
                    if (statEl) statEl.style.opacity = '0.3';
                }

                // Redessiner le graphique
                if (globalChartModalOpen) {
                    drawGlobalDetailedChart();
                }
            }

            function openGlobalChartModal() {
                globalChartModalOpen = true;
                const modal = document.getElementById('global-chart-modal');

                // Calculer la duree de session
                let sessionDuration = 'Session en cours';
                const masterData = agentCharts.master;
                if (masterData && masterData.sessionStart) {
                    const now = new Date();
                    const diffMs = now - masterData.sessionStart;
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    sessionDuration = `Session demarree il y a ${hours}h ${minutes}min`;
                }
                document.getElementById('global-chart-subtitle').textContent =
                    `Toutes les courbes de performance - ${sessionDuration}`;

                // Calculer les stats pour chaque agent
                const formatVal = (val) => {
                    const sign = val >= 0 ? '+' : '';
                    return `${sign}${val.toFixed(2)} EUR`;
                };

                // Stats globales
                const masterClosed = masterData.closed.length > 0 ? masterData.closed[masterData.closed.length - 1] : 0;
                const masterOpen = masterData.open.length > 0 ? masterData.open[masterData.open.length - 1] : masterClosed;
                const totalFloating = masterOpen - masterClosed;

                document.getElementById('global-stat-total').textContent = formatVal(masterOpen);
                document.getElementById('global-stat-total').style.color = masterOpen >= 0 ? 'var(--accent-pink)' : 'var(--accent-red)';

                document.getElementById('global-stat-session').textContent = formatVal(masterClosed);
                document.getElementById('global-stat-session').style.color = masterClosed >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                document.getElementById('global-stat-floating').textContent = formatVal(totalFloating);
                document.getElementById('global-stat-floating').style.color = totalFloating >= 0 ? 'var(--accent-blue)' : 'var(--accent-red)';

                document.getElementById('global-stat-points').textContent = masterData.closed.length || 0;

                // Stats par agent
                ['fibo1', 'fibo2', 'fibo3'].forEach(agentId => {
                    const data = agentCharts[agentId];
                    const lastVal = data.open.length > 0 ? data.open[data.open.length - 1] : 0;
                    const el = document.getElementById(`global-stat-${agentId}`);
                    if (el) {
                        el.textContent = formatVal(lastVal);
                        el.style.color = lastVal >= 0 ? agentColors[agentId].main : 'var(--accent-red)';
                    }
                });

                // Stat MASTER
                document.getElementById('global-stat-master').textContent = formatVal(masterOpen);
                document.getElementById('global-stat-master').style.color = masterOpen >= 0 ? 'var(--accent-pink)' : 'var(--accent-red)';

                // Afficher le modal
                modal.style.display = 'flex';

                // Dessiner le graphique apres un court delai
                setTimeout(() => drawGlobalDetailedChart(), 50);
            }

            function closeGlobalChartModal() {
                globalChartModalOpen = false;
                document.getElementById('global-chart-modal').style.display = 'none';
            }

            function drawGlobalDetailedChart() {
                const canvas = document.getElementById('global-chart-canvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;

                // Ajuster la taille du canvas
                canvas.width = container.clientWidth - 40;
                canvas.height = container.clientHeight - 40;

                // Marges pour les axes (marginRight augmente pour afficher la valeur finale)
                const marginLeft = 90;
                const marginRight = 120;
                const marginTop = 40;
                const marginBottom = 70;

                const chartWidth = canvas.width - marginLeft - marginRight;
                const chartHeight = canvas.height - marginTop - marginBottom;

                // Effacer
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Fond
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(marginLeft, marginTop, chartWidth, chartHeight);

                // Recuperer les donnees de tous les agents
                const masterData = agentCharts.master;
                const numPoints = masterData.closed.length;

                if (numPoints === 0) {
                    ctx.textAlign = 'center';
                    ctx.font = '20px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.fillText('Aucune donnee - En attente de trades', canvas.width / 2, canvas.height / 2);
                    return;
                }

                // Preparer les donnees pour chaque courbe
                const curves = {
                    global: { data: masterData.open, color: '#ffffff', width: 3, name: 'Global Total' },
                    fibo1: { data: agentCharts.fibo1.open, color: '#3b82f6', width: 2, name: 'FIBO1' },
                    fibo2: { data: agentCharts.fibo2.open, color: '#10b981', width: 2, name: 'FIBO2' },
                    fibo3: { data: agentCharts.fibo3.open, color: '#ec4899', width: 2, name: 'FIBO3' },
                    floating: { data: [], color: '#a855f7', width: 1, dashed: true, name: 'P&L Flottant' },
                    session: { data: masterData.closed, color: '#06b6d4', width: 3, dashed: false, name: 'P&L Session' }
                };

                // Calculer le floating (difference entre open et closed)
                for (let i = 0; i < numPoints; i++) {
                    const openVal = masterData.open[i] || 0;
                    const closedVal = masterData.closed[i] || 0;
                    curves.floating.data.push(openVal - closedVal);
                }

                // Trouver min/max de toutes les courbes
                let allValues = [];
                Object.values(curves).forEach(curve => {
                    if (curve.data.length > 0) {
                        allValues = allValues.concat(curve.data);
                    }
                });

                const minVal = Math.min(0, ...allValues);
                const maxVal = Math.max(0, ...allValues);
                const range = Math.max(0.1, maxVal - minVal);
                const padding = range * 0.1;

                // Fonction pour convertir valeur en Y
                const valueToY = (val) => {
                    return marginTop + chartHeight - ((val - minVal + padding) / (range + 2 * padding)) * chartHeight;
                };

                const stepX = chartWidth / Math.max(numPoints - 1, 1);

                // Grille horizontale
                ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                ctx.lineWidth = 1;
                const gridLines = 8;
                for (let i = 0; i <= gridLines; i++) {
                    const val = minVal + (range * i / gridLines);
                    const y = valueToY(val);
                    ctx.beginPath();
                    ctx.moveTo(marginLeft, y);
                    ctx.lineTo(marginLeft + chartWidth, y);
                    ctx.stroke();

                    // Labels Y
                    ctx.textAlign = 'right';
                    ctx.font = '13px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.fillText(`${val.toFixed(2)} EUR`, marginLeft - 10, y + 4);
                }

                // Ligne zero (plus visible)
                const zeroY = valueToY(0);
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([8, 4]);
                ctx.beginPath();
                ctx.moveTo(marginLeft, zeroY);
                ctx.lineTo(marginLeft + chartWidth, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);

                // Labels X (timestamps)
                ctx.textAlign = 'center';
                ctx.font = '12px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                const xLabelsCount = Math.min(12, numPoints);
                const xLabelStep = Math.floor(numPoints / xLabelsCount) || 1;
                for (let i = 0; i < numPoints; i += xLabelStep) {
                    const x = marginLeft + i * stepX;
                    const timestamp = masterData.timestamps[i];
                    if (timestamp) {
                        const time = timestamp.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        ctx.fillText(time, x, canvas.height - marginBottom + 25);
                    }
                }

                // Titre de l'axe X
                ctx.font = '14px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.fillText('Temps', marginLeft + chartWidth / 2, canvas.height - 10);

                // Titre de l'axe Y
                ctx.save();
                ctx.translate(15, marginTop + chartHeight / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('P&L (EUR)', 0, 0);
                ctx.restore();

                // Dessiner chaque courbe (respecter la visibilite)
                const curveOrder = ['session', 'floating', 'fibo3', 'fibo2', 'fibo1', 'global'];
                curveOrder.forEach(curveId => {
                    // Verifier si la courbe est visible
                    if (!globalCurveVisibility[curveId]) return;

                    const curve = curves[curveId];
                    if (!curve.data || curve.data.length === 0) return;

                    ctx.strokeStyle = curve.color;
                    ctx.lineWidth = curve.width;

                    if (curve.dashed) {
                        ctx.setLineDash(Array.isArray(curve.dashed) ? curve.dashed : [6, 3]);
                    } else {
                        ctx.setLineDash([]);
                    }

                    ctx.beginPath();
                    curve.data.forEach((val, i) => {
                        const x = marginLeft + i * stepX;
                        const y = valueToY(val || 0);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    ctx.setLineDash([]);
                });

                // Point final sur la courbe globale (seulement si visible)
                if (globalCurveVisibility.global && curves.global.data.length > 0) {
                    const lastX = marginLeft + (numPoints - 1) * stepX;
                    const lastY = valueToY(curves.global.data[numPoints - 1]);
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 8, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fill();
                    ctx.strokeStyle = '#333333';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Valeur finale
                    ctx.textAlign = 'left';
                    ctx.font = 'bold 16px Arial';
                    const finalVal = curves.global.data[numPoints - 1];
                    ctx.fillStyle = finalVal >= 0 ? '#10b981' : '#ef4444';
                    ctx.fillText(`${finalVal >= 0 ? '+' : ''}${finalVal.toFixed(2)} EUR`, lastX + 15, lastY - 5);
                }

                // Setup tooltip
                setupGlobalChartTooltip(canvas, curves, marginLeft, marginRight, marginTop, marginBottom, stepX, valueToY, numPoints);
            }

            function setupGlobalChartTooltip(canvas, curves, marginLeft, marginRight, marginTop, marginBottom, stepX, valueToY, numPoints) {
                const tooltip = document.getElementById('global-chart-tooltip');
                const masterData = agentCharts.master;

                canvas.onmousemove = null;
                canvas.onmouseleave = null;

                canvas.onmousemove = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const chartWidth = canvas.width - marginLeft - marginRight;
                    if (x < marginLeft || x > marginLeft + chartWidth) {
                        tooltip.style.display = 'none';
                        return;
                    }

                    const relativeX = x - marginLeft;
                    const index = Math.round(relativeX / stepX);

                    if (index >= 0 && index < numPoints) {
                        const timestamp = masterData.timestamps[index];
                        const timeStr = timestamp ? timestamp.toLocaleString('fr-FR', {
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        }) : 'N/A';

                        document.getElementById('global-tooltip-time').textContent = `Point ${index + 1} - ${timeStr}`;

                        const formatVal = (val) => `${val >= 0 ? '+' : ''}${(val || 0).toFixed(2)}`;

                        // Global
                        const globalEl = document.getElementById('global-tooltip-total');
                        const globalVal = curves.global.data[index] || 0;
                        globalEl.textContent = formatVal(globalVal);
                        globalEl.style.color = globalVal >= 0 ? '#10b981' : '#ef4444';

                        // Momentum
                        const momEl = document.getElementById('global-tooltip-fibo1');
                        const momVal = curves.fibo1.data[index] || 0;
                        momEl.textContent = formatVal(momVal);
                        momEl.style.color = momVal >= 0 ? '#10b981' : '#ef4444';

                        // Fibo
                        const fiboEl = document.getElementById('global-tooltip-fibo');
                        const fiboVal = curves.fibo2.data[index] || 0;
                        fiboEl.textContent = formatVal(fiboVal);
                        fiboEl.style.color = fiboVal >= 0 ? '#10b981' : '#ef4444';

                        // Liquidation
                        const liqEl = document.getElementById('global-tooltip-fibo3');
                        const liqVal = curves.fibo3.data[index] || 0;
                        liqEl.textContent = formatVal(liqVal);
                        liqEl.style.color = liqVal >= 0 ? '#10b981' : '#ef4444';

                        // Floating
                        const floatEl = document.getElementById('global-tooltip-floating');
                        const floatVal = curves.floating.data[index] || 0;
                        floatEl.textContent = formatVal(floatVal);
                        floatEl.style.color = floatVal >= 0 ? '#10b981' : '#ef4444';

                        // Session
                        const sessEl = document.getElementById('global-tooltip-session');
                        const sessVal = curves.session.data[index] || 0;
                        sessEl.textContent = formatVal(sessVal);
                        sessEl.style.color = sessVal >= 0 ? '#10b981' : '#ef4444';

                        // Position tooltip
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${x + 20}px`;
                        tooltip.style.top = `${y - 30}px`;

                        // Eviter debordement
                        const tooltipRect = tooltip.getBoundingClientRect();
                        const containerRect = canvas.parentElement.getBoundingClientRect();
                        if (tooltipRect.right > containerRect.right) {
                            tooltip.style.left = `${x - tooltipRect.width - 20}px`;
                        }
                    } else {
                        tooltip.style.display = 'none';
                    }
                };

                canvas.onmouseleave = () => {
                    tooltip.style.display = 'none';
                };
            }

            function exportGlobalChartData() {
                const masterData = agentCharts.master;

                if (masterData.closed.length === 0) {
                    alert('Aucune donnee a exporter');
                    return;
                }

                // CSV header
                let csv = 'Index,Timestamp,Global_Total,FIBO1,FIBO2,FIBO3,Floating_PnL,Session_PnL\n';

                const numPoints = masterData.closed.length;
                for (let i = 0; i < numPoints; i++) {
                    const timestamp = masterData.timestamps[i] ? masterData.timestamps[i].toISOString() : '';
                    const globalTotal = (masterData.open[i] || 0).toFixed(2);
                    const fibo1pnl = (agentCharts.fibo1.open[i] || 0).toFixed(2);
                    const fibo = (agentCharts.fibo2.open[i] || 0).toFixed(2);
                    const fibo3pnl = (agentCharts.fibo3.open[i] || 0).toFixed(2);
                    const floating = ((masterData.open[i] || 0) - (masterData.closed[i] || 0)).toFixed(2);
                    const session = (masterData.closed[i] || 0).toFixed(2);

                    csv += `${i + 1},${timestamp},${globalTotal},${fibo1pnl},${fibo},${fibo3pnl},${floating},${session}\n`;
                }

                // Telecharger
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `global_performance_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // Fermer modal avec Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (currentChartModalAgent) {
                        closeChartModal();
                    }
                    if (globalChartModalOpen) {
                        closeGlobalChartModal();
                    }
                }
            });

            // Initialisation unique
            document.addEventListener('DOMContentLoaded', () => {
                refreshData();
                startAutoRefresh();
                loadAllConfigs();
                loadAgentAccounts();
                loadApiKeys();
                loadSessionInfo();
                loadStrategistInsights();
                loadChartHistory(); // Restaurer graphiques depuis l'historique persiste
                // Initialiser les graphiques
                setTimeout(drawAllCharts, 100);
                // Redessiner on resize
                window.addEventListener('resize', drawAllCharts);
            });

            async function loadChartHistory() {
                try {
                    const response = await fetch(`${API_URL}/api/session/performance`);
                    const data = await response.json();

                    if (data.performance && Object.keys(data.performance).length > 0) {
                        console.log('[Chart] Chargement historique performance...');

                        // Reset charts data avant de charger l'historique
                        ['fibo1', 'fibo2', 'fibo3', 'master'].forEach(agentId => {
                            agentCharts[agentId] = { closed: [], open: [], timestamps: [], sessionStart: null };
                        });

                        // Charger l'historique pour chaque agent
                        for (const [agentId, history] of Object.entries(data.performance)) {
                            if (agentCharts[agentId] && Array.isArray(history) && history.length > 0) {
                                agentCharts[agentId].sessionStart = new Date(history[0].timestamp);

                                history.forEach(point => {
                                    agentCharts[agentId].closed.push(point.closed_pnl || 0);
                                    agentCharts[agentId].open.push((point.closed_pnl || 0) + (point.floating_pnl || 0));
                                    agentCharts[agentId].timestamps.push(new Date(point.timestamp));
                                });
                                console.log(`[Chart] ${agentId}: ${history.length} points restaures`);
                                drawAgentChart(agentId);
                            }
                        }
                        console.log("[Chart] Graphiques restaures depuis l'historique");
                    } else {
                        console.log("[Chart] Pas d'historique, graphiques vierges");
                    }
                } catch (error) {
                    console.error('[Chart] Erreur chargement historique:', error);
                }
            }

            // Flag pour eviter les requetes concurrentes
            let isRefreshing = false;

            function startAutoRefresh() {
                if (refreshInterval) clearInterval(refreshInterval);
                // Intervalle de 2 secondes pour temps reel
                refreshInterval = setInterval(refreshData, 2000);
            }

            async function refreshData() {
                // Eviter les requetes concurrentes qui saturent le serveur
                if (isRefreshing) {
                    console.log('[UI] Requete en cours, skip...');
                    return;
                }
                isRefreshing = true;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout

                    const response = await fetch(`${API_URL}/api/status`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    const data = await response.json();
                    updateUI(data);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.error('Erreur refresh: Timeout');
                    } else {
                        console.error('Erreur refresh:', error);
                    }
                    document.getElementById('mt5-status').className = 'status-badge disconnected';
                    document.getElementById('mt5-status').textContent = 'API: Erreur';
                } finally {
                    isRefreshing = false;
                }
            }

            function updateUI(data) {
                // MT5 Status
                const mt5Status = document.getElementById('mt5-status');
                if (data.mt5?.connected) {
                    mt5Status.className = 'status-badge connected';
                    mt5Status.textContent = 'MT5: Connecte';
                } else {
                    mt5Status.className = 'status-badge disconnected';
                    mt5Status.textContent = 'MT5: Deconnecte';
                }

                // Trading Status
                const tradingStatus = document.getElementById('trading-status');
                const tradingText = tradingStatus.querySelector('.indicator-text');
                if (data.loops?.trading?.running) {
                    tradingStatus.className = 'trading-indicator trading-active';
                    tradingText.textContent = 'TRADING ACTIF';
                } else {
                    tradingStatus.className = 'trading-indicator trading-stopped';
                    tradingText.textContent = 'TRADING ARRETE';
                }

                // Session
                console.log('[Session] data.session:', data.session);
                if (data.session) {
                    const sessionBadge = document.getElementById('session-badge');
                    sessionBadge.textContent = `Session: ${data.session.name}`;
                    sessionBadge.className = `session-badge ${data.session.volatility}`;

                    // Mettre a jour la section ANALYSE avec session et volatilite
                    document.getElementById('current-session-name').textContent = data.session.name || '--';
                    const volEl = document.getElementById('session-volatility');
                    volEl.textContent = data.session.volatility?.toUpperCase() || '--';
                    // Couleur selon volatilite
                    if (data.session.volatility === 'high' || data.session.volatility === 'ultra') {
                        volEl.style.color = 'var(--accent-red)';
                    } else if (data.session.volatility === 'medium') {
                        volEl.style.color = 'var(--accent-orange)';
                    } else {
                        volEl.style.color = 'var(--accent-green)';
                    }

                    // Mettre a jour les Killzones visuelles
                    if (data.session.sessions) {
                        Object.keys(data.session.sessions).forEach(key => {
                            const kzEl = document.getElementById(`kz-${key}`);
                            if (kzEl) {
                                if (data.session.sessions[key].active) {
                                    kzEl.classList.add('active');
                                } else {
                                    kzEl.classList.remove('active');
                                }
                            }
                        });
                    }
                } else {
                    console.warn('[Session] data.session est undefined/null');
                    document.getElementById('current-session-name').textContent = 'Non disponible';
                    document.getElementById('session-volatility').textContent = '--';
                }

                // Price
                if (data.price) {
                    const price = data.price.price;
                    const priceFormatted = `$${price?.toLocaleString('en-US', { minimumFractionDigits: 2 }) || '--'}`;
                    document.getElementById('price-value').textContent = priceFormatted;
                    document.getElementById('price-value-header').textContent = priceFormatted;

                    const mom1m = data.price.fibo1?.['1m'];
                    const changeEl = document.getElementById('price-change');
                    const changeHeaderEl = document.getElementById('price-change-header');
                    if (mom1m !== null && mom1m !== undefined) {
                        const sign = mom1m >= 0 ? '+' : '';
                        const changeText = `${sign}${mom1m.toFixed(3)}% (1min)`;
                        changeEl.textContent = changeText;
                        changeEl.className = `price-change ${mom1m >= 0 ? 'positive' : 'negative'}`;
                        // Mettre a jour aussi le header (visible quand plie)
                        changeHeaderEl.textContent = changeText;
                        changeHeaderEl.style.color = mom1m >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    }

                    document.getElementById('spread-value').textContent = `${data.price.spread_points || '--'} pts`;

                    // Spread tracking pour TP/SL du laboratoire
                    const currentSpread = data.price.spread_points;
                    if (currentSpread !== null && currentSpread !== undefined) {
                        // Mettre a jour min/max
                        if (spreadMin === null || currentSpread < spreadMin) spreadMin = currentSpread;
                        if (spreadMax === null || currentSpread > spreadMax) spreadMax = currentSpread;

                        // Afficher dans le laboratoire
                        document.getElementById('spread-current').textContent = `${currentSpread} pts`;
                        document.getElementById('spread-min').textContent = `${spreadMin} pts`;
                        document.getElementById('spread-max').textContent = `${spreadMax} pts`;
                    }

                    // Momentums
                    updateMomentum('mom-1m', data.price.fibo1?.['1m']);
                    updateMomentum('mom-5m', data.price.fibo1?.['5m']);

                    document.getElementById('volatility').textContent = `${data.price.volatility_pct?.toFixed(2) || '--'}%`;
                }

                // Analysis
                if (data.analysis) {
                    const biasEl = document.getElementById('analysis-bias');
                    biasEl.textContent = `${data.analysis.bias?.toUpperCase()} (${data.analysis.confidence}%)`;
                    biasEl.className = `data-value ${data.analysis.bias === 'bullish' ? 'positive' : data.analysis.bias === 'bearish' ? 'negative' : ''}`;
                }

                // Futures
                if (data.futures) {
                    updateValue('funding-rate', data.futures.funding_rate, '%', true);
                    updateValue('oi-change', data.futures.oi_change_1h, '%', true);
                    document.getElementById('ls-ratio').textContent = data.futures.long_short_ratio?.toFixed(2) || '--';
                    document.getElementById('orderbook-bias').textContent = data.futures.orderbook_bias?.toUpperCase() || '--';
                }

                // News
                const newsAlert = document.getElementById('news-alert-box');
                if (data.pause_recommended) {
                    newsAlert.style.display = 'block';
                } else {
                    newsAlert.style.display = 'none';
                }

                if (data.sentiment) {
                    const fg = data.sentiment.fear_greed_index;
                    document.getElementById('fg-value').textContent = `${fg || '--'} (${data.sentiment.fear_greed_label || '--'})`;
                    if (fg) {
                        document.getElementById('fg-marker').style.left = `${fg}%`;
                    }
                    document.getElementById('news-sentiment').textContent = data.sentiment.news_bias?.toUpperCase() || '--';
                    document.getElementById('global-bias').textContent = data.sentiment.global_bias?.toUpperCase() || '--';
                }

                // Account - Mise a jour via loadAccountsStatus() pour les 3 comptes

                // Positions
                updatePositions(data.positions || []);
                document.getElementById('position-count').textContent = data.positions?.length || 0;

                // Decisions recentes
                updateDecisionsLog(data.decisions || []);

                // Agents (passer les positions MT5 pour calculer le P&L ouvert)
                const mt5Positions = data.positions || [];
                let totalClosedPnl = 0;  // Somme des session_pnl de tous les agents (VRAIS trades MT5)
                let totalOpenPnl = 0;

                if (data.agents) {
                    // FIBO1
                    updateAgent('fibo1', data.agents.fibo1, mt5Positions);

                    // FIBO2
                    updateAgent('fibo2', data.agents.fibo2, mt5Positions);

                    // FIBO3
                    updateAgent('fibo3', data.agents.fibo3, mt5Positions);

                    // Calcul Open P&L Total (Somme de toutes les positions MT5)
                    totalOpenPnl = mt5Positions.reduce((sum, pos) => sum + (pos.profit || 0), 0);

                    // totalClosedPnl = stats.total_profit (source unique: stats_*.json)
                    // Sera mis a jour apres le chargement des stats ci-dessous
                }

                // Stats
                try {
                    console.log('[Stats] data.stats:', data.stats);
                    if (data.stats) {
                        updateStats(data.stats);

                        // Metrics - Win Rate
                        document.getElementById('metric-winrate').textContent = `${data.stats.win_rate || 0}%`;

                        // P&L Session = stats.total_profit (source unique: stats_*.json synchronise avec MT5)
                        // Utilise la meme source que le tableau Stat Session pour coherence
                        const pnlSession = data.stats.total_profit || 0;
                        totalClosedPnl = pnlSession;  // Mettre a jour pour le graphique

                        const pnlEl = document.getElementById('metric-pnl');
                        pnlEl.textContent = `${pnlSession >= 0 ? '+' : ''}${pnlSession.toFixed(2)} EUR`;
                        pnlEl.style.color = pnlSession >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                        // Mise a jour du graphique MASTER avec source unique
                        updateAgentChartData('master', totalClosedPnl, totalOpenPnl);

                        console.log(`[P&L Session] From stats.total_profit: ${pnlSession.toFixed(2)} EUR`);
                    } else {
                        console.warn('[Stats] data.stats est undefined/null');
                        updateStats({ agents: null }); // Force affichage "Pas de donnees"
                    }
                } catch (statsError) {
                    console.error('[Stats] Erreur:', statsError);
                }

                // Nouvelles metriques - P&L Flottant, Capital Depart, Capital Total
                // P&L Flottant - TOUJOURS calculer depuis les positions (incluent TOUS les agents)
                // car l'aggregator ne retourne le floating_pnl que de l'agent actuellement connecte
                let floatingPnl = 0;
                if (data.positions && data.positions.length > 0) {
                    // Calculer depuis TOUTES les positions (fiable car main.py agrege tous les agents)
                    floatingPnl = data.positions.reduce((sum, pos) => sum + (pos.profit || 0), 0);
                    console.log(`[P&L] Calcule depuis ${data.positions.length} positions: ${floatingPnl.toFixed(2)} EUR`);
                } else if (data.account && data.account.floating_pnl !== undefined) {
                    // Fallback: utiliser la valeur de l'aggregateur si pas de positions
                    floatingPnl = data.account.floating_pnl;
                    console.log(`[P&L] Utilise floating_pnl aggregateur: ${floatingPnl.toFixed(2)} EUR`);
                }
                const floatingPnlEl = document.getElementById('metric-floating-pnl');
                floatingPnlEl.textContent = `${floatingPnl >= 0 ? '+' : ''}${floatingPnl.toFixed(2)} EUR`;
                floatingPnlEl.style.color = floatingPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                // Capital Depart et Capital Total - utiliser data.account de /api/status
                // qui agrege deja tous les comptes MT5 correctement
                const startCapitalEl = document.getElementById('metric-start-capital');
                const totalCapitalEl = document.getElementById('metric-total-capital');

                if (data.account && data.account.equity > 0) {
                    // Capital Total = equity totale (balance + P&L flottant)
                    const totalEquity = data.account.equity;
                    totalCapitalEl.textContent = `${totalEquity.toFixed(2)} EUR`;
                    totalCapitalEl.style.color = 'var(--text-primary)';

                    // Capital Depart = balance au debut de la session G13
                    // Utilise data.session.balance_start (sauvegarde lors du start trading)
                    const balanceStart = data.session?.balance_start || totalEquity;
                    startCapitalEl.textContent = `${balanceStart.toFixed(2)} EUR`;

                    console.log(`[Capital] Balance Start (session): ${balanceStart.toFixed(2)} EUR, Equity: ${totalEquity.toFixed(2)} EUR`);

                    // Mettre a jour la section "Comptes MT5" avec les donnees par compte
                    if (data.account.accounts) {
                        for (const [agentId, accInfo] of Object.entries(data.account.accounts)) {
                            const mt5LoginEl = document.getElementById(`mt5-${agentId}-login`);
                            const mt5BalanceEl = document.getElementById(`mt5-${agentId}-balance`);
                            const mt5EquityEl = document.getElementById(`mt5-${agentId}-equity`);

                            if (mt5LoginEl && accInfo.login) {
                                mt5LoginEl.textContent = accInfo.login;
                            }
                            if (mt5BalanceEl && accInfo.balance) {
                                mt5BalanceEl.textContent = `${accInfo.balance.toFixed(2)} EUR`;
                            }
                            if (mt5EquityEl && accInfo.equity) {
                                mt5EquityEl.textContent = `${accInfo.equity.toFixed(2)} EUR`;
                            }
                        }
                    }
                } else {
                    startCapitalEl.textContent = '-- EUR';
                    totalCapitalEl.textContent = '-- EUR';
                    totalCapitalEl.style.color = 'var(--text-secondary)';
                }
            }

            // Calcule et affiche Capital Depart et Capital Total = somme de tous les comptes connectes
            function updateTotalCapital() {
                let totalCapital = 0;
                let connectedCount = 0;

                // Sommer tous les comptes connectes
                console.log('[Capital] Donnees comptes:', JSON.stringify(accountsStatusData));
                for (const [agentId, info] of Object.entries(accountsStatusData)) {
                    if (info.connected) {
                        // Utiliser equity (valeur reelle avec P&L) ou balance comme fallback
                        const capital = info.equity || info.balance || 0;
                        totalCapital += capital;
                        connectedCount++;
                        console.log(`[Capital] ${agentId}: ${capital} EUR`);
                    }
                }

                console.log(`[Capital] TOTAL: ${connectedCount} comptes = ${totalCapital} EUR`);

                // Capital Depart ET Capital Total = meme valeur (somme des comptes)
                // Ils ne different que si on a une session avec un start_balance different
                const startCapitalEl = document.getElementById('metric-start-capital');
                const totalCapitalEl = document.getElementById('metric-total-capital');

                if (connectedCount > 0) {
                    startCapitalEl.textContent = `${totalCapital.toFixed(2)} EUR`;
                    totalCapitalEl.textContent = `${totalCapital.toFixed(2)} EUR`;
                    totalCapitalEl.style.color = 'var(--text-primary)';
                } else {
                    startCapitalEl.textContent = '-- EUR';
                    totalCapitalEl.textContent = '-- EUR';
                    totalCapitalEl.style.color = 'var(--text-secondary)';
                }
            }

            function updateMomentum(id, value) {
                const el = document.getElementById(id);
                if (value !== null && value !== undefined) {
                    const sign = value >= 0 ? '+' : '';
                    el.textContent = `${sign}${value.toFixed(3)}%`;
                    el.className = `data-value ${value >= 0 ? 'positive' : 'negative'}`;
                } else {
                    el.textContent = '--%';
                    el.className = 'data-value';
                }
            }

            function updateValue(id, value, suffix = '', colored = false) {
                const el = document.getElementById(id);
                if (value !== null && value !== undefined) {
                    const sign = value >= 0 ? '+' : '';
                    el.textContent = `${sign}${value.toFixed(3)}${suffix}`;
                    if (colored) {
                        el.className = `data-value ${value >= 0 ? 'positive' : 'negative'}`;
                    }
                } else {
                    el.textContent = `--${suffix}`;
                    el.className = 'data-value';
                }
            }

            function updatePositions(positions) {
                console.log('[DEBUG] updatePositions called with:', positions);
                const container = document.getElementById('positions-container');
                const countEl = document.getElementById('positions-count');

                // Mettre a jour le compteur
                if (countEl) {
                    countEl.textContent = positions ? positions.length : 0;
                }

                if (!positions || positions.length === 0) {
                    container.innerHTML = `
                    <div style="color: var(--text-secondary); font-size: 18px; text-align: center; padding: 30px;">
                        Aucune position ouverte
                    </div>
                `;
                    return;
                }

                container.innerHTML = positions.map(pos => {
                    // Extraire le nom de l'agent depuis le commentaire (format: "G13_fibo" -> "FIBO2")
                    let agentName = '';
                    if (pos.comment) {
                        const match = pos.comment.match(/G13_(\w+)/i);
                        if (match) {
                            agentName = match[1].toUpperCase();
                        }
                    }

                    return `
                <div class="position-row">
                    <div class="position-header">
                        <div class="position-left">
                            <span class="position-direction ${pos.type?.toLowerCase()}">${pos.type}</span>
                            ${agentName ? `<span class="position-agent">${agentName}</span>` : ''}
                        </div>
                        <span class="position-profit" style="color: ${pos.profit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                            ${pos.profit >= 0 ? '+' : ''}${pos.profit?.toFixed(2)} EUR
                        </span>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 18px;">
                        <span><span style="color: var(--text-secondary);">Entry:</span> $${pos.price_open?.toLocaleString()}</span>
                        <span><span style="color: var(--text-secondary);">Current:</span> $${pos.price_current?.toLocaleString()}</span>
                        <span><span style="color: var(--text-secondary);">Vol:</span> ${pos.volume}</span>
                    </div>
                </div>
            `}).join('');
            }

            function updateDecisionsLog(decisions) {
                const container = document.getElementById('decisions-log');

                if (!decisions || decisions.length === 0) {
                    container.innerHTML = `
                    <div style="color: var(--text-secondary); font-size: 18px; text-align: center; padding: 20px;">
                        Aucune decision
                    </div>
                `;
                    return;
                }

                // Stocker les decisions pour les afficher au clic
                window._lastDecisions = decisions.slice(0, 10);

                container.innerHTML = decisions.slice(0, 10).map((d, index) => {
                    // Couleur selon la decision
                    let actionColor = 'var(--text-secondary)';
                    let actionBg = 'rgba(148,163,184,0.2)';
                    if (d.decision === 'BUY') {
                        actionColor = 'var(--accent-green)';
                        actionBg = 'rgba(16,185,129,0.2)';
                    } else if (d.decision === 'SELL') {
                        actionColor = 'var(--accent-red)';
                        actionBg = 'rgba(239,68,68,0.2)';
                    } else if (d.decision === 'CLOSE' || d.decision === 'KEEP') {
                        actionColor = 'var(--accent-orange)';
                        actionBg = 'rgba(245,158,11,0.2)';
                    }

                    // Formater l'heure
                    let timeStr = '--';
                    if (d.timestamp) {
                        const dt = new Date(d.timestamp);
                        timeStr = dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    }

                    return `
                    <div onclick="showFullDecision(${index})" style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 10px; align-items: center; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <span style="background: ${actionBg}; color: ${actionColor}; padding: 2px 8px; border-radius: 4px; font-size: 18px; font-weight: bold; min-width: 50px; text-align: center;">
                            ${d.decision || '--'}
                        </span>
                        <span style="color: var(--text-secondary); font-size: 18px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${d.agent_id?.toUpperCase() || '?'}: ${(d.reason || 'Pas de raison').substring(0, 50)}...
                        </span>
                        <span style="color: var(--text-secondary); font-size: 18px;">
                            ${timeStr}
                        </span>
                    </div>
                `;
                }).join('');
            }

            // Affiche la decision complete dans une modale
            function showFullDecision(index) {
                const decision = window._lastDecisions?.[index];
                if (!decision) return;

                // Couleur selon la decision
                let actionColor = '#94a3b8';
                if (decision.decision === 'BUY') actionColor = '#10b981';
                else if (decision.decision === 'SELL') actionColor = '#ef4444';
                else if (decision.decision === 'CLOSE' || decision.decision === 'KEEP') actionColor = '#f59e0b';

                // Formater l'heure
                let timeStr = '--';
                if (decision.timestamp) {
                    const dt = new Date(decision.timestamp);
                    timeStr = dt.toLocaleString('fr-FR');
                }

                // Creer la modale
                const modal = document.createElement('div');
                modal.id = 'decision-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10000;';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                    <div style="background: var(--bg-secondary, #1e293b); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="background: ${actionColor}22; color: ${actionColor}; padding: 6px 16px; border-radius: 6px; font-size: 20px; font-weight: bold;">
                                    ${decision.decision || '--'}
                                </span>
                                <span style="color: var(--text-primary, #fff); font-size: 20px; font-weight: bold;">
                                    ${decision.agent_id?.toUpperCase() || '?'}
                                </span>
                            </div>
                            <button onclick="document.getElementById('decision-modal').remove()" style="background: none; border: none; color: var(--text-secondary, #94a3b8); font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="color: var(--text-secondary, #94a3b8); font-size: 18px; margin-bottom: 16px;">
                            ${timeStr}
                        </div>
                        <div style="color: var(--text-primary, #fff); font-size: 18px; line-height: 1.6; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            ${decision.reason || 'Pas de raison'}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            function updateAgent(id, agent, mt5Positions = []) {
                if (!agent) return;

                // Mise a jour de l'aspect brillant/terne
                const card = document.querySelector(`.agent-card.${id}`);
                if (card) {
                    if (agent.enabled) {
                        card.classList.remove('inactive-trading');
                        card.classList.add('active-trading');
                    } else {
                        card.classList.remove('active-trading');
                        card.classList.add('inactive-trading');
                    }
                }

                // Status
                const statusEl = document.getElementById(`${id}-status`);
                if (!agent.enabled) {
                    statusEl.textContent = 'Desactive';
                    statusEl.className = 'agent-status disabled';
                } else if (agent.has_position) {
                    statusEl.textContent = 'En position';
                    statusEl.className = 'agent-status active';
                } else if (agent.in_cooldown) {
                    statusEl.textContent = 'Cooldown';
                    statusEl.className = 'agent-status idle';
                } else {
                    statusEl.textContent = 'Actif';
                    statusEl.className = 'agent-status active';
                }

                // Toggle
                document.getElementById(`${id}-toggle`).checked = agent.enabled;

                // Position - Calculer P&L depuis positions MT5 reelles
                const posEl = document.getElementById(`${id}-position`);
                let openPnl = 0;

                // Filtrer les positions MT5 de cet agent (par agent_id ou comment)
                const agentMt5Positions = mt5Positions.filter(pos => {
                    // Verifier agent_id
                    if (pos.agent_id === id) return true;
                    // Ou verifier le comment (format: G13_fibo1)
                    const comment = (pos.comment || '').toLowerCase();
                    return comment.includes(`g13_${id}`);
                });

                if (agentMt5Positions.length > 0) {
                    // Calculer le P&L FLOTTANT des positions ouvertes depuis MT5
                    openPnl = agentMt5Positions.reduce((sum, pos) => sum + (pos.profit || 0), 0);
                    // Afficher le nombre de positions
                    posEl.textContent = `${agentMt5Positions.length} pos`;
                    posEl.style.color = openPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                } else {
                    posEl.textContent = '--';
                    posEl.style.color = 'var(--text-secondary)';
                }

                // Stats - P&L ferme et P&L flottant separes
                const sessionPnl = agent.session_pnl || 0;

                // P&L Ferme (trades clotures)
                const pnlClosedEl = document.getElementById(`${id}-pnl-closed`);
                if (pnlClosedEl) {
                    pnlClosedEl.textContent = `${sessionPnl >= 0 ? '+' : ''}${sessionPnl.toFixed(2)}`;
                    pnlClosedEl.style.color = sessionPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                }

                // P&L Flottant (positions ouvertes)
                const pnlEl = document.getElementById(`${id}-pnl`);
                pnlEl.textContent = `${openPnl >= 0 ? '+' : ''}${openPnl.toFixed(2)}`;
                pnlEl.style.color = openPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';

                // Trades = trades fermes + positions ouvertes (total trades ouverts dans la session)
                const closedTrades = agent.session_trades || 0;
                const totalTrades = closedTrades + agentMt5Positions.length;
                console.log(`[DEBUG] ${id}: closedTrades=${closedTrades}, mt5Pos=${agentMt5Positions.length}, total=${totalTrades}`);
                document.getElementById(`${id}-trades`).textContent = totalTrades;
                // Win rate retire des cartes agents - affiche dans Stat Session uniquement

                // Mettre a jour le graphique de performance
                updateAgentChartData(id, sessionPnl, openPnl);

                // Mettre a jour le log de decisions
                const actionEl = document.getElementById(`${id}-decision-action`);
                const reasonEl = document.getElementById(`${id}-decision-reason`);
                const timeEl = document.getElementById(`${id}-decision-time`);

                if (agent.last_decision) {
                    const action = agent.last_decision.action || '--';
                    actionEl.textContent = action;

                    // Couleur selon l'action
                    if (action === 'BUY') {
                        actionEl.style.background = 'rgba(16,185,129,0.2)';
                        actionEl.style.color = 'var(--accent-green)';
                    } else if (action === 'SELL') {
                        actionEl.style.background = 'rgba(239,68,68,0.2)';
                        actionEl.style.color = 'var(--accent-red)';
                    } else if (action === 'HOLD') {
                        actionEl.style.background = 'rgba(148,163,184,0.2)';
                        actionEl.style.color = 'var(--text-secondary)';
                    } else if (action === 'KEEP' || action === 'CLOSE') {
                        actionEl.style.background = 'rgba(245,158,11,0.2)';
                        actionEl.style.color = 'var(--accent-orange)';
                    }

                    reasonEl.textContent = agent.last_decision.reason || 'En attente...';

                    // Formater le temps
                    if (agent.last_decision_time) {
                        const dt = new Date(agent.last_decision_time);
                        timeEl.textContent = dt.toLocaleTimeString('fr-FR');
                    } else {
                        timeEl.textContent = '--';
                    }
                } else {
                    actionEl.textContent = '--';
                    actionEl.style.background = 'rgba(148,163,184,0.2)';
                    actionEl.style.color = 'var(--text-secondary)';
                    reasonEl.textContent = 'En attente de decision...';
                    timeEl.textContent = '--';
                }
            }

            function updateStats(stats) {
                const tbody = document.getElementById('stats-table');

                if (!stats.agents) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Pas de donnees</td></tr>';
                    return;
                }

                const agents = ['fibo1', 'fibo2', 'fibo3'];
                let html = '';

                agents.forEach(agentId => {
                    const s = stats.agents[agentId] || {};
                    const pnl = s.total_profit || 0;

                    html += `
                    <tr>
                        <td style="font-weight: 600; text-transform: uppercase;">${agentId}</td>
                        <td>${s.total_trades || 0}</td>
                        <td style="color: var(--accent-green)">${s.winning_trades || 0}</td>
                        <td style="color: var(--accent-red)">${s.losing_trades || 0}</td>
                        <td>${s.win_rate || 0}%</td>
                        <td style="color: ${pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                            ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} EUR
                        </td>
                        <td>${s.avg_profit?.toFixed(2) || '0.00'} EUR</td>
                        <td><button onclick="showAgentTrades('${agentId}')" class="btn btn-secondary" style="font-size: 18px; padding: 4px 10px;">Details</button></td>
                    </tr>
                `;
                });

                // Total row
                const totalPnl = stats.total_profit || 0;
                html += `
                <tr style="background: var(--bg-input); font-weight: 600;">
                    <td>TOTAL</td>
                    <td>${stats.total_trades || 0}</td>
                    <td style="color: var(--accent-green)">${stats.total_wins || 0}</td>
                    <td style="color: var(--accent-red)">${stats.total_losses || 0}</td>
                    <td>${stats.win_rate || 0}%</td>
                    <td style="color: ${totalPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                        ${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)} EUR
                    </td>
                    <td>--</td>
                    <td><button onclick="showAgentTrades('all')" class="btn btn-primary" style="font-size: 18px; padding: 4px 10px;">Tous</button></td>
                </tr>
            `;

                tbody.innerHTML = html;
            }

            // Actions
            async function startTrading() {
                try {
                    const response = await fetch(`${API_URL}/api/trading/start`, { method: 'POST' });
                    const result = await response.json();
                    alert(result.message);
                    refreshData();
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }

            async function stopTrading() {
                try {
                    const response = await fetch(`${API_URL}/api/trading/stop`, { method: 'POST' });
                    const result = await response.json();
                    alert(result.message || 'Trading arrete');
                    refreshData();
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }

            async function closeAllPositions() {
                if (!confirm('Fermer toutes les positions?')) return;

                try {
                    const response = await fetch(`${API_URL}/api/trading/close-all`, { method: 'POST' });
                    const result = await response.json();
                    alert(`${result.closed} positions fermees. P&L: ${result.total_profit?.toFixed(2)} EUR`);
                    refreshData();
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }

            async function toggleAgent(agentId, enabled) {
                try {
                    // Utilise GET car POST bloque quand le serveur est sous charge MT5
                    await fetch(`${API_URL}/api/agents/toggle?agent_id=${agentId}&enabled=${enabled}`);
                    refreshData();
                } catch (error) {
                    console.error('Erreur toggle agent:', error);
                }
            }

            // ================================================================
            // LABORATOIRE - GESTION DES CONFIGURATIONS
            // ================================================================

            // Charger toutes les configurations au demarrage
            async function loadAllConfigs() {
                try {
                    const response = await fetch(`${API_URL}/api/config/all`);
                    const config = await response.json();

                    // Charger config agents
                    if (config.agents) {
                        for (const [agentId, agentConfig] of Object.entries(config.agents)) {
                            for (const [key, value] of Object.entries(agentConfig)) {
                                const input = document.getElementById(`cfg-${agentId}-${key}`);
                                if (input) {
                                    if (input.type === 'checkbox') {
                                        input.checked = value;
                                    } else {
                                        input.value = value;
                                    }
                                }
                            }
                        }
                    }

                    // Charger config risque
                    if (config.risk) {
                        for (const [key, value] of Object.entries(config.risk)) {
                            const input = document.getElementById(`cfg-risk-${key}`);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = value;
                                } else {
                                    input.value = value;
                                }
                            }
                        }
                    }

                    // Charger config spread/TP/SL
                    if (config.spread) {
                        for (const [key, value] of Object.entries(config.spread)) {
                            const input = document.getElementById(`cfg-spread-${key}`);
                            if (input) {
                                if (input.type === 'checkbox') {
                                    input.checked = value;
                                } else {
                                    input.value = value;
                                }
                            }
                        }
                    }

                    console.log('Configurations chargees');
                } catch (error) {
                    console.error('Erreur chargement config:', error);
                }
            }

            // Sauvegarder config agent
            async function saveAgentConfig(agentId) {
                const config = {};
                const prefix = `cfg-${agentId}-`;

                document.querySelectorAll(`[id^="${prefix}"]`).forEach(input => {
                    const key = input.id.replace(prefix, '');
                    if (input.type === 'checkbox') {
                        config[key] = input.checked;
                    } else if (input.tagName === 'SELECT') {
                        // Convertir "true"/"false" en boolean pour les selects booleens
                        if (input.value === 'true') config[key] = true;
                        else if (input.value === 'false') config[key] = false;
                        else config[key] = input.value;
                    } else {
                        // Pour les inputs numeriques
                        const numVal = parseFloat(input.value);
                        config[key] = isNaN(numVal) ? input.value : numVal;
                    }
                });

                try {
                    const response = await fetch(`${API_URL}/api/config/agent/${agentId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    const result = await response.json();

                    if (result.success) {
                        showNotification(`Agent ${agentId.toUpperCase()} mis a jour!`, 'success');
                    } else {
                        showNotification('Erreur: ' + result.message, 'error');
                    }
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            // Sauvegarder config risque
            async function saveRiskConfig() {
                const config = {};

                document.querySelectorAll('[id^="cfg-risk-"]').forEach(input => {
                    const key = input.id.replace('cfg-risk-', '');
                    if (input.type === 'checkbox') {
                        config[key] = input.checked;
                    } else {
                        config[key] = parseFloat(input.value);
                    }
                });

                try {
                    // Sauvegarder config risque
                    const response = await fetch(`${API_URL}/api/config/risk`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    const result = await response.json();

                    // Sauvegarder aussi le spread max
                    const spreadMax = document.getElementById('cfg-spread-max_spread_points').value;
                    await fetch(`${API_URL}/api/config/spread`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ max_spread_points: parseFloat(spreadMax) })
                    });

                    if (result.success) {
                        showNotification('Configuration RISQUE mise a jour!', 'success');
                    } else {
                        showNotification('Erreur: ' + result.message, 'error');
                    }
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            // Sauvegarder config spread/TP/SL
            async function saveSpreadConfig() {
                const config = {};

                document.querySelectorAll('[id^="cfg-spread-"]').forEach(input => {
                    const key = input.id.replace('cfg-spread-', '');
                    // Gerer les checkboxes vs inputs numeriques
                    if (input.type === 'checkbox') {
                        config[key] = input.checked;
                    } else {
                        config[key] = parseFloat(input.value);
                    }
                });

                try {
                    const response = await fetch(`${API_URL}/api/config/spread`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    const result = await response.json();

                    if (result.success) {
                        showNotification('Configuration TP/SL mise a jour!', 'success');
                    } else {
                        showNotification('Erreur: ' + result.message, 'error');
                    }
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            // Sauvegarder tout
            async function saveAllConfigs() {
                await saveAgentConfig('fibo1');
                await saveAgentConfig('fibo2');
                await saveAgentConfig('fibo3');
                await saveRiskConfig();
                await saveSpreadConfig();
                showNotification('Toutes les configurations sauvegardees!', 'success');
            }

            // Reset valeurs par defaut
            function resetToDefaults() {
                if (!confirm('Remettre toutes les valeurs par defaut?')) return;

                // Momentum defaults
                document.getElementById('cfg-fibo1-decision_interval').value = 10;
                document.getElementById('cfg-fibo1-signal_timeframe').value = 'M5';
                document.getElementById('cfg-fibo1-min_fibo1_pct').value = 0.05;
                document.getElementById('cfg-fibo1-position_size_pct').value = 0.01;
                document.getElementById('cfg-fibo1-tp_spread_multiplier').value = 3;
                document.getElementById('cfg-fibo1-sl_spread_multiplier').value = 2;
                document.getElementById('cfg-fibo1-cooldown_seconds').value = 60;
                document.getElementById('cfg-fibo1-max_positions').value = 1;
                document.getElementById('cfg-fibo1-max_drawdown_pct').value = 5;
                document.getElementById('cfg-fibo1-min_winrate_pct').value = 20;
                document.getElementById('cfg-fibo1-min_trades_for_eval').value = 10;

                // Fibo defaults
                document.getElementById('cfg-fibo2-decision_interval').value = 10;
                document.getElementById('cfg-fibo2-signal_timeframe').value = 'M15';
                document.getElementById('cfg-fibo2-fibo_level').value = '0.618';
                document.getElementById('cfg-fibo2-fibo_tolerance_pct').value = 0.3;
                document.getElementById('cfg-fibo2-position_size_pct').value = 0.01;
                document.getElementById('cfg-fibo2-cooldown_seconds').value = 120;
                document.getElementById('cfg-fibo2-max_positions').value = 1;
                document.getElementById('cfg-fibo2-max_drawdown_pct').value = 5;
                document.getElementById('cfg-fibo2-min_winrate_pct').value = 20;
                document.getElementById('cfg-fibo2-min_trades_for_eval').value = 10;

                // Liquidation defaults
                document.getElementById('cfg-fibo3-decision_interval').value = 10;
                document.getElementById('cfg-fibo3-signal_timeframe').value = 'M1';
                document.getElementById('cfg-fibo3-min_fibo3_usd').value = 1000000;
                document.getElementById('cfg-fibo3-funding_rate_threshold').value = 0.01;
                document.getElementById('cfg-fibo3-position_size_pct').value = 0.01;
                document.getElementById('cfg-fibo3-tp_spread_multiplier').value = 4;
                document.getElementById('cfg-fibo3-sl_spread_multiplier').value = 2;
                document.getElementById('cfg-fibo3-cooldown_seconds').value = 30;
                document.getElementById('cfg-fibo3-max_positions').value = 1;
                document.getElementById('cfg-fibo3-max_drawdown_pct').value = 5;
                document.getElementById('cfg-fibo3-min_winrate_pct').value = 20;
                document.getElementById('cfg-fibo3-min_trades_for_eval').value = 10;

                // Risk defaults
                document.getElementById('cfg-risk-max_drawdown_pct').value = 10;
                document.getElementById('cfg-risk-max_daily_loss_pct').value = 5;
                document.getElementById('cfg-risk-max_positions_total').value = 3;
                document.getElementById('cfg-risk-emergency_close_pct').value = 15;
                document.getElementById('cfg-risk-winner_never_loser').checked = true;

                // TP/SL % defaults (Strategie Exponentielle)
                document.getElementById('cfg-spread-spread_check_enabled').checked = true;
                document.getElementById('cfg-spread-trailing_enabled').checked = true;
                document.getElementById('cfg-spread-break_even_enabled').checked = true;
                document.getElementById('cfg-spread-max_spread_points').value = 2000;
                document.getElementById('cfg-spread-tp_pct').value = 0.3;
                document.getElementById('cfg-spread-sl_pct').value = 0.5;
                document.getElementById('cfg-spread-trailing_start_pct').value = 0.2;
                document.getElementById('cfg-spread-trailing_distance_pct').value = 0.1;
                document.getElementById('cfg-spread-break_even_pct').value = 0.15;

                showNotification('Valeurs par defaut restaurees', 'success');
            }

            // Exporter config JSON
            function exportConfig() {
                const config = {
                    agents: {
                        fibo1: {},
                        fibo2: {},
                        fibo3: {}
                    },
                    risk: {},
                    spread: {}
                };

                // Collecter toutes les valeurs
                ['fibo1', 'fibo2', 'fibo3'].forEach(agentId => {
                    document.querySelectorAll(`[id^="cfg-${agentId}-"]`).forEach(input => {
                        const key = input.id.replace(`cfg-${agentId}-`, '');
                        config.agents[agentId][key] = input.type === 'checkbox' ? input.checked : parseFloat(input.value);
                    });
                });

                document.querySelectorAll('[id^="cfg-risk-"]').forEach(input => {
                    const key = input.id.replace('cfg-risk-', '');
                    config.risk[key] = input.type === 'checkbox' ? input.checked : parseFloat(input.value);
                });

                document.querySelectorAll('[id^="cfg-spread-"]').forEach(input => {
                    const key = input.id.replace('cfg-spread-', '');
                    config.spread[key] = parseFloat(input.value);
                });

                // Telecharger JSON
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `g11_config_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showNotification('Configuration exportee!', 'success');
            }

            // ================================================================
            // MULTI-COMPTE (UN AGENT = UN COMPTE)
            // ================================================================
            async function loadAgentAccounts() {
                try {
                    const response = await fetch(`${API_URL}/api/accounts`);
                    const accounts = await response.json();

                    for (const [agentId, account] of Object.entries(accounts)) {
                        const loginInput = document.getElementById(`acc-${agentId}-login`);
                        const serverInput = document.getElementById(`acc-${agentId}-server`);
                        const pathSelect = document.getElementById(`acc-${agentId}-path`);
                        const enabledInput = document.getElementById(`acc-${agentId}-enabled`);

                        if (loginInput && account.login) loginInput.value = account.login;
                        if (serverInput && account.server) serverInput.value = account.server;
                        if (pathSelect && account.path) pathSelect.value = account.path;
                        if (enabledInput) enabledInput.checked = account.enabled !== false;
                    }

                    // Charger le status
                    loadAccountsStatus();
                    // Charger les configs agents (ia_adjust_enabled etc.)
                    loadAgentConfigs();
                } catch (error) {
                    console.error('Erreur chargement comptes:', error);
                }
            }

            async function loadAgentConfigs() {
                // Charge les configs de chaque agent depuis l'API et met a jour les selects
                try {
                    const response = await fetch(`${API_URL}/api/config/all`);
                    if (!response.ok) return;
                    const data = await response.json();
                    const agents = data.agents || {};

                    for (const agentId of ['fibo1', 'fibo2', 'fibo3']) {
                        const config = agents[agentId];
                        if (!config) continue;

                        // Mettre a jour le select ia_adjust_enabled
                        const adjustSelect = document.getElementById(`cfg-${agentId}-ia_adjust_enabled`);
                        if (adjustSelect && config.ia_adjust_enabled !== undefined) {
                            adjustSelect.value = config.ia_adjust_enabled ? 'true' : 'false';
                        }
                    }
                } catch (e) {
                    console.warn('Erreur chargement configs agents:', e);
                }
            }

            async function loadAccountsStatus() {
                try {
                    const response = await fetch(`${API_URL}/api/accounts/status/all`);
                    const status = await response.json();

                    // Stocker globalement pour reference
                    accountsStatusData = status;

                    // Note: Capital Depart et Total sont geres par /api/status (data.account)
                    // updateTotalCapital() n'est plus necessaire

                    for (const [agentId, info] of Object.entries(status)) {
                        const statusEl = document.getElementById(`acc-${agentId}-status`);
                        const balanceEl = document.getElementById(`acc-${agentId}-balance`);

                        if (statusEl) {
                            if (info.connected) {
                                statusEl.textContent = 'Connecte';
                                statusEl.style.background = 'rgba(16, 185, 129, 0.2)';
                                statusEl.style.color = 'var(--accent-green)';
                            } else if (info.configured && info.enabled) {
                                statusEl.textContent = 'Deconnecte';
                                statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                                statusEl.style.color = 'var(--accent-red)';
                            } else if (!info.enabled) {
                                statusEl.textContent = 'Desactive';
                                statusEl.style.background = 'rgba(148, 163, 184, 0.2)';
                                statusEl.style.color = 'var(--text-secondary)';
                            } else {
                                statusEl.textContent = 'Non configure';
                                statusEl.style.background = 'rgba(245, 158, 11, 0.2)';
                                statusEl.style.color = 'var(--accent-orange)';
                            }
                        }

                        if (balanceEl) {
                            if (info.balance) {
                                balanceEl.textContent = `${info.balance.toFixed(2)} EUR`;
                            } else {
                                balanceEl.textContent = '--';
                            }
                        }

                        // NOTE: La section "Comptes MT5" est mise a jour par /api/status (data.account.accounts)
                        // Ne PAS mettre a jour ici car /api/accounts/status/all utilise des donnees en cache
                        // qui peuvent etre perimees. Laisser updateUI() gerer ces elements.
                    }

                    // Calculer et afficher le total
                    let totalBalance = 0;
                    for (const info of Object.values(status)) {
                        if (info.balance) {
                            totalBalance += info.balance;
                        }
                    }
                    const totalEl = document.getElementById('mt5-total-balance');
                    if (totalEl) {
                        totalEl.textContent = `${totalBalance.toFixed(2)} EUR`;
                    }
                } catch (error) {
                    console.error('Erreur chargement status comptes:', error);
                }
            }

            async function saveAgentAccount(agentId) {
                const config = {
                    login: parseInt(document.getElementById(`acc-${agentId}-login`).value) || 0,
                    password: document.getElementById(`acc-${agentId}-password`).value || '',
                    server: document.getElementById(`acc-${agentId}-server`).value || '',
                    path: document.getElementById(`acc-${agentId}-path`).value || '',
                    enabled: document.getElementById(`acc-${agentId}-enabled`).checked
                };

                try {
                    const response = await fetch(`${API_URL}/api/accounts/${agentId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    const result = await response.json();

                    if (result.success) {
                        showNotification(`Compte ${agentId.toUpperCase()} sauvegarde!`, 'success');
                        loadAccountsStatus();
                    } else {
                        showNotification('Erreur: ' + result.detail, 'error');
                    }
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            async function testAgentAccount(agentId) {
                const statusEl = document.getElementById(`acc-${agentId}-status`);
                if (statusEl) {
                    statusEl.textContent = 'Test...';
                    statusEl.style.background = 'rgba(59, 130, 246, 0.2)';
                    statusEl.style.color = 'var(--accent-blue)';
                }

                try {
                    const response = await fetch(`${API_URL}/api/accounts/${agentId}/test`, { method: 'POST' });
                    const result = await response.json();

                    if (result.connected) {
                        showNotification(`${agentId.toUpperCase()} connecte! Balance: ${result.balance?.toFixed(2) || 0} EUR`, 'success');
                        const balanceEl = document.getElementById(`acc-${agentId}-balance`);
                        if (balanceEl && result.balance) {
                            balanceEl.textContent = `${result.balance.toFixed(2)} EUR`;
                        }
                    } else {
                        showNotification(`${agentId.toUpperCase()}: ${result.error || 'Echec connexion'}`, 'error');
                    }

                    loadAccountsStatus();
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                    loadAccountsStatus();
                }
            }

            // ================================================================
            // GLOBAL DATA - Comptes et API Keys
            // ================================================================
            let accountsStatusData = {};  // Stocke le statut de tous les comptes pour le capital total
            let apiKeysData = { keys: [] };
            let apiSelectionsData = { selections: {} };  // Stocke les selections de cles par agent

            async function loadApiKeys() {
                try {
                    // Charger les cles API
                    const keysResponse = await fetch(`${API_URL}/api/keys`);
                    if (keysResponse.ok) {
                        apiKeysData = await keysResponse.json();
                        console.log('[API Keys] Cles chargees:', apiKeysData.keys.length);
                    } else {
                        console.error('[API Keys] Erreur chargement cles:', keysResponse.status);
                        apiKeysData = { keys: [] };
                    }

                    // Charger les selections sauvegardees
                    try {
                        const selectionsResponse = await fetch(`${API_URL}/api/keys/selections`);
                        if (selectionsResponse.ok) {
                            apiSelectionsData = await selectionsResponse.json();
                            console.log('[API Keys] Selections chargees:', apiSelectionsData.selections);
                        } else {
                            console.log('[API Keys] Pas de selections (endpoint non disponible)');
                            apiSelectionsData = { selections: {} };
                        }
                    } catch (e) {
                        console.log('[API Keys] Erreur selections:', e.message);
                        apiSelectionsData = { selections: {} };
                    }

                    populateApiKeySelects();
                } catch (error) {
                    console.error('[API Keys] Erreur generale:', error);
                    apiKeysData = { keys: [] };
                    populateApiKeySelects();  // Toujours populer meme si erreur
                }
            }

            function populateApiKeySelects() {
                const selects = document.querySelectorAll('.api-key-select');
                console.log('[API Keys] Population des selects, cles disponibles:', apiKeysData.keys.map(k => k.name));

                selects.forEach(select => {
                    const agent = select.dataset.agent;

                    select.innerHTML = '<option value="">-- Selectionner une cle --</option>';
                    apiKeysData.keys.forEach(key => {
                        const option = document.createElement('option');
                        option.value = key.id;
                        option.textContent = `${key.name} (${key.provider})`;
                        option.dataset.key = key.key;
                        option.dataset.provider = key.provider;
                        option.dataset.model = key.model || '';
                        select.appendChild(option);
                    });

                    // Restaurer la selection sauvegardee
                    const savedSelection = apiSelectionsData.selections ? apiSelectionsData.selections[agent] : null;
                    if (savedSelection) {
                        select.value = savedSelection;
                        console.log(`[API Keys] Restauration ${agent}: ${savedSelection}`);
                        showApiKeyPreview(agent, false);  // false = ne pas re-sauvegarder
                    }
                });
            }

            function showApiKeyPreview(agent, save = true) {
                const select = document.getElementById(`api-${agent}-key`);
                const preview = document.getElementById(`api-${agent}-preview`);
                const selectedOption = select.options[select.selectedIndex];

                if (select.value && selectedOption.dataset.key) {
                    const key = selectedOption.dataset.key;
                    const masked = key.substring(0, 12) + '****' + key.substring(key.length - 6);
                    preview.innerHTML = `<span style="color: var(--accent-green);">${selectedOption.dataset.provider}</span> | ${selectedOption.dataset.model}<br><span style="opacity: 0.7;">${masked}</span>`;

                    // Sauvegarder la selection
                    if (save) {
                        saveApiSelection(agent, select.value);
                    }
                } else {
                    preview.innerHTML = '<span style="opacity: 0.5;">Aucune cle selectionnee</span>';
                    if (save) {
                        saveApiSelection(agent, '');
                    }
                }
            }

            async function saveApiSelection(agent, keyId) {
                apiSelectionsData.selections[agent] = keyId;
                try {
                    await fetch(`${API_URL}/api/keys/selections`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiSelectionsData)
                    });
                    console.log(`[API] Selection sauvegardee: ${agent} = ${keyId}`);
                } catch (error) {
                    console.error('Erreur sauvegarde selection:', error);
                }
            }

            function openApiManager() {
                document.getElementById('api-manager-modal').style.display = 'flex';
                renderApiKeysList();
            }

            function closeApiManager() {
                document.getElementById('api-manager-modal').style.display = 'none';
            }

            // Mapping provider -> modeles disponibles (defini avant renderApiKeysList)
            const providerModels = {
                anthropic: [
                    { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4' },
                    { value: 'claude-3-5-sonnet', label: 'Claude 3.5 Sonnet' }
                ],
                openai: [
                    { value: 'gpt-4o', label: 'GPT-4o' },
                    { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                    { value: 'o3-mini', label: 'o3-mini' }
                ],
                google: [
                    { value: 'gemini-2.0-flash', label: 'Gemini 2.0 Flash' },
                    { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' }
                ],
                deepseek: [
                    { value: 'deepseek-chat', label: 'DeepSeek Chat' },
                    { value: 'deepseek-reasoner', label: 'DeepSeek Reasoner' }
                ],
                mistral: [
                    { value: 'mistral-large', label: 'Mistral Large' }
                ],
                meta: [
                    { value: 'llama-3.3-70b', label: 'Llama 3.3 70B' }
                ],
                cohere: [
                    { value: 'command-r-plus', label: 'Command R+' }
                ],
                xai: [
                    { value: 'grok-2', label: 'Grok 2' }
                ],
                alibaba: [
                    { value: 'qwen3-max', label: 'Qwen3 Max' }
                ],
                groq: [
                    { value: 'llama-3.3-70b-versatile', label: 'Llama 3.3 70B' },
                    { value: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B' },
                    { value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B' },
                    { value: 'llama-3.1-8b-instant', label: 'Llama 3.1 8B (Fast)' }
                ]
            };

            function getModelOptionsHtml(provider, selectedModel) {
                const models = providerModels[provider] || providerModels['anthropic'];
                return models.map(m =>
                    `<option value="${m.value}" ${m.value === selectedModel ? 'selected' : ''}>${m.label}</option>`
                ).join('');
            }

            function updateModelDropdown(providerSelectId, modelSelectId) {
                const provider = document.getElementById(providerSelectId).value;
                const modelSelect = document.getElementById(modelSelectId);
                const models = providerModels[provider] || [];
                modelSelect.innerHTML = models.map(m =>
                    `<option value="${m.value}">${m.label}</option>`
                ).join('');
            }

            function renderApiKeysList() {
                const container = document.getElementById('api-keys-list');
                if (apiKeysData.keys.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Aucune cle API enregistree</div>';
                    return;
                }

                container.innerHTML = apiKeysData.keys.map((key, idx) => {
                    const maskedKey = key.key.substring(0, 15) + '****' + key.key.substring(key.key.length - 8);
                    return `
                    <div id="api-key-row-${key.id}" style="background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid ${getProviderColor(key.provider)};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--text-primary);">${key.name}</div>
                                <div id="api-key-info-${key.id}" style="font-size: 18px; color: var(--text-secondary);">${key.provider} | ${key.model}</div>
                                <div style="font-size: 18px; font-family: monospace; color: var(--text-secondary); margin-top: 4px;">${maskedKey}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="showEditApiKey('${key.id}')" class="btn btn-secondary" style="font-size: 18px; padding: 6px 12px;">Modifier</button>
                                <button onclick="deleteApiKey('${key.id}')" class="btn btn-danger" style="font-size: 18px; padding: 6px 12px;">Supprimer</button>
                            </div>
                        </div>
                        <!-- Formulaire de modification (cache par defaut) -->
                        <div id="api-key-edit-${key.id}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="font-size: 18px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Provider</label>
                                    <select id="edit-provider-${key.id}" onchange="updateModelDropdown('edit-provider-${key.id}', 'edit-model-${key.id}')" style="width: 100%; padding: 10px; font-size: 18px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                        <option value="anthropic" ${key.provider === 'anthropic' ? 'selected' : ''}>Anthropic (Claude)</option>
                                        <option value="openai" ${key.provider === 'openai' ? 'selected' : ''}>OpenAI (GPT)</option>
                                        <option value="google" ${key.provider === 'google' ? 'selected' : ''}>Google (Gemini)</option>
                                        <option value="deepseek" ${key.provider === 'deepseek' ? 'selected' : ''}>DeepSeek</option>
                                        <option value="mistral" ${key.provider === 'mistral' ? 'selected' : ''}>Mistral</option>
                                        <option value="meta" ${key.provider === 'meta' ? 'selected' : ''}>Meta (Llama)</option>
                                        <option value="cohere" ${key.provider === 'cohere' ? 'selected' : ''}>Cohere</option>
                                        <option value="xai" ${key.provider === 'xai' ? 'selected' : ''}>xAI (Grok)</option>
                                        <option value="alibaba" ${key.provider === 'alibaba' ? 'selected' : ''}>Alibaba (Qwen)</option>
                                        <option value="groq" ${key.provider === 'groq' ? 'selected' : ''}>Groq (Ultra-Fast)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 18px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Modele</label>
                                    <select id="edit-model-${key.id}" style="width: 100%; padding: 10px; font-size: 18px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                        ${getModelOptionsHtml(key.provider, key.model)}
                                    </select>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button onclick="saveEditApiKey('${key.id}')" class="btn btn-success" style="font-size: 18px; padding: 8px 16px;">Sauvegarder</button>
                                <button onclick="cancelEditApiKey('${key.id}')" class="btn btn-secondary" style="font-size: 18px; padding: 8px 16px;">Annuler</button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            function getProviderColor(provider) {
                switch (provider) {
                    case 'anthropic': return '#3b82f6';
                    case 'openai': return '#10b981';
                    case 'google': return '#f59e0b';
                    case 'deepseek': return '#8b5cf6';
                    case 'mistral': return '#ef4444';
                    case 'meta': return '#0ea5e9';
                    case 'cohere': return '#ec4899';
                    case 'xai': return '#6366f1';
                    case 'alibaba': return '#f97316';
                    default: return '#94a3b8';
                }
            }

            async function addApiKey() {
                const name = document.getElementById('new-api-name').value.trim();
                const provider = document.getElementById('new-api-provider').value;
                const key = document.getElementById('new-api-key').value.trim();
                const model = document.getElementById('new-api-model').value;

                if (!name || !key) {
                    showNotification('Nom et cle API requis', 'error');
                    return;
                }

                const newKey = {
                    id: `key_${Date.now()}`,
                    name: name,
                    key: key,
                    provider: provider,
                    model: model
                };

                apiKeysData.keys.push(newKey);

                try {
                    await fetch(`${API_URL}/api/keys`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiKeysData)
                    });

                    showNotification('Cle API ajoutee', 'success');
                    document.getElementById('new-api-name').value = '';
                    document.getElementById('new-api-key').value = '';
                    renderApiKeysList();
                    populateApiKeySelects();
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            async function deleteApiKey(keyId) {
                if (!confirm('Supprimer cette cle API ?')) return;

                apiKeysData.keys = apiKeysData.keys.filter(k => k.id !== keyId);

                try {
                    await fetch(`${API_URL}/api/keys`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiKeysData)
                    });

                    showNotification('Cle supprimee', 'success');
                    renderApiKeysList();
                    populateApiKeySelects();
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            // Afficher le formulaire de modification
            function showEditApiKey(keyId) {
                // Cacher tous les autres formulaires d'edition
                document.querySelectorAll('[id^="api-key-edit-"]').forEach(el => {
                    el.style.display = 'none';
                });
                // Afficher le formulaire de cette cle
                const editForm = document.getElementById(`api-key-edit-${keyId}`);
                if (editForm) {
                    editForm.style.display = 'block';
                }
            }

            // Annuler la modification
            function cancelEditApiKey(keyId) {
                const editForm = document.getElementById(`api-key-edit-${keyId}`);
                if (editForm) {
                    editForm.style.display = 'none';
                }
            }

            // Sauvegarder la modification
            async function saveEditApiKey(keyId) {
                const newProvider = document.getElementById(`edit-provider-${keyId}`).value;
                const newModel = document.getElementById(`edit-model-${keyId}`).value;

                // Trouver et mettre a jour la cle
                const keyIndex = apiKeysData.keys.findIndex(k => k.id === keyId);
                if (keyIndex === -1) {
                    showNotification('Cle non trouvee', 'error');
                    return;
                }

                apiKeysData.keys[keyIndex].provider = newProvider;
                apiKeysData.keys[keyIndex].model = newModel;

                try {
                    await fetch(`${API_URL}/api/keys`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiKeysData)
                    });

                    showNotification('Cle API modifiee', 'success');
                    renderApiKeysList();
                    populateApiKeySelects();
                } catch (error) {
                    showNotification('Erreur: ' + error.message, 'error');
                }
            }

            // ================================================================
            // STRATEGIST FUNCTIONS
            // ================================================================
            async function loadStrategistInsights() {
                try {
                    const response = await fetch(`${API_URL}/api/strategist/insights`);
                    const insights = await response.json();

                    if (insights.status === 'ok') {
                        document.getElementById('strategist-winrate').textContent = `${insights.recent_win_rate}%`;
                        document.getElementById('strategist-best').textContent = insights.best_agent?.toUpperCase() || '--';
                        document.getElementById('strategist-worst').textContent = insights.worst_agent?.toUpperCase() || '--';
                        document.getElementById('strategist-trend').textContent = insights.trend === 'up' ? 'Hausse' : 'Baisse';
                        document.getElementById('strategist-trend').style.color = insights.trend === 'up' ? 'var(--accent-green)' : 'var(--accent-red)';
                    } else {
                        document.getElementById('strategist-winrate').textContent = 'Pas assez de data';
                    }
                } catch (error) {
                    console.error('Erreur Strategist:', error);
                }
            }

            async function showFullAnalysis() {
                try {
                    const response = await fetch(`${API_URL}/api/strategist/analyze`);
                    const analysis = await response.json();

                    if (analysis.status === 'insufficient_data') {
                        alert(analysis.message);
                        return;
                    }

                    let message = '=== ANALYSE STRATEGIST ===\n\n';
                    message += `Win Rate Global: ${analysis.global?.win_rate}%\n`;
                    message += `Profit Factor: ${analysis.global?.profit_factor}\n`;
                    message += `Total Trades: ${analysis.global?.total_trades}\n\n`;

                    if (analysis.suggestions && analysis.suggestions.length > 0) {
                        message += '=== SUGGESTIONS ===\n';
                        analysis.suggestions.forEach((s, i) => {
                            message += `${i + 1}. [${s.priority}] ${s.suggestion}\n   Raison: ${s.reason}\n\n`;
                        });
                    }

                    alert(message);
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }

            // Ouvrir la modal des logs Strategist
            async function showStrategistLogs() {
                document.getElementById('strategist-logs-modal').style.display = 'flex';
                await refreshStrategistLogs();
            }

            // Fermer la modal des logs Strategist
            function closeStrategistLogs() {
                document.getElementById('strategist-logs-modal').style.display = 'none';
            }

            // Executer les suggestions du Strategist
            async function executeStrategistSuggestions() {
                if (!confirm('Appliquer automatiquement les corrections?\n\nCeci va:\n- Augmenter les seuils des agents sous-performants\n- Ajuster les TP/SL si profit factor trop bas\n- Desactiver les agents a 0% win rate')) return;

                try {
                    const response = await fetch(`${API_URL}/api/strategist/execute`, { method: 'POST' });
                    const result = await response.json();

                    if (result.executed_count > 0) {
                        showNotification(`${result.executed_count} corrections appliquees!`, 'success');
                        // Rafraichir les logs pour voir les actions
                        await refreshStrategistLogs();
                    } else {
                        showNotification('Aucune correction necessaire ou applicable', 'info');
                    }
                } catch (error) {
                    console.error('Erreur execution suggestions:', error);
                    showNotification('Erreur lors de l\'execution des corrections', 'error');
                }
            }

            // Actualiser les logs Strategist
            async function refreshStrategistLogs() {
                try {
                    // Recuperer l'analyse complete
                    const analysisResp = await fetch(`${API_URL}/api/strategist/analyze`);
                    const analysis = await analysisResp.json();

                    // Afficher les suggestions
                    const suggestionsEl = document.getElementById('strategist-suggestions');
                    if (analysis.suggestions && analysis.suggestions.length > 0) {
                        suggestionsEl.innerHTML = analysis.suggestions.map(s => {
                            const priorityColor = s.priority === 'critical' ? 'var(--accent-red)' :
                                s.priority === 'high' ? 'var(--accent-orange)' : 'var(--accent-blue)';
                            return `
                            <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px;">
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 6px;">
                                    <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 18px; text-transform: uppercase;">${s.priority}</span>
                                    <span style="color: var(--text-secondary); font-size: 18px;">[${s.category}]</span>
                                </div>
                                <div style="font-size: 18px; color: var(--text-primary); margin-bottom: 4px;">${s.suggestion}</div>
                                <div style="font-size: 18px; color: var(--text-secondary);">Raison: ${s.reason}</div>
                            </div>
                        `;
                        }).join('');
                    } else if (analysis.status === 'insufficient_data') {
                        suggestionsEl.innerHTML = `<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Pas assez de trades pour generer des suggestions (${analysis.message})</div>`;
                    } else {
                        suggestionsEl.innerHTML = `<div style="color: var(--accent-green); text-align: center; padding: 20px;">Aucune suggestion - tout semble optimal!</div>`;
                    }

                    // ========== SECTION 1: Rapport d'analyse (patterns, performance) ==========
                    let analysisHtml = '';

                    // Patterns detectes
                    if (analysis.patterns && analysis.patterns.length > 0) {
                        analysisHtml += `<div style="font-size: 18px; color: var(--accent-orange); margin-bottom: 10px; font-weight: 600;">Patterns detectes</div>`;
                        analysis.patterns.forEach(p => {
                            const severityColor = p.severity === 'critical' ? 'var(--accent-red)' : 'var(--accent-orange)';
                            analysisHtml += `
                            <div style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 8px;">
                                <span style="color: ${severityColor}; font-weight: 600;">[${p.type}]</span>
                                <span style="color: var(--text-primary); margin-left: 8px;">${p.description}</span>
                            </div>
                        `;
                        });
                    }

                    // Stats par agent
                    if (analysis.by_agent) {
                        analysisHtml += `<div style="font-size: 18px; color: var(--accent-blue); margin: 16px 0 10px 0; font-weight: 600;">Performance par agent</div>`;
                        for (const [agent, stats] of Object.entries(analysis.by_agent)) {
                            const pnlColor = stats.total_profit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                            analysisHtml += `
                            <div style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between;">
                                <span style="color: var(--text-primary); font-weight: 600; text-transform: uppercase;">${agent}</span>
                                <span style="color: var(--text-secondary);">${stats.total_trades} trades | Win: ${stats.win_rate}% | PF: ${stats.profit_factor}</span>
                                <span style="color: ${pnlColor}; font-weight: 600;">${stats.total_profit >= 0 ? '+' : ''}${stats.total_profit?.toFixed(2)} EUR</span>
                            </div>
                        `;
                        }
                    }

                    // Stats par session
                    if (analysis.by_session) {
                        analysisHtml += `<div style="font-size: 18px; color: var(--accent-purple); margin: 16px 0 10px 0; font-weight: 600;">Performance par session</div>`;
                        for (const [session, stats] of Object.entries(analysis.by_session)) {
                            if (stats.trades > 0) {
                                const pnlColor = stats.total_profit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                                analysisHtml += `
                                <div style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-primary); font-weight: 600; text-transform: uppercase;">${session}</span>
                                    <span style="color: var(--text-secondary);">${stats.trades} trades | Win: ${stats.win_rate}%</span>
                                    <span style="color: ${pnlColor}; font-weight: 600;">${stats.total_profit >= 0 ? '+' : ''}${stats.total_profit?.toFixed(2)} EUR</span>
                                </div>
                            `;
                            }
                        }
                    }

                    // Stats globales
                    if (analysis.global) {
                        const g = analysis.global;
                        analysisHtml += `<div style="font-size: 18px; color: var(--accent-green); margin: 16px 0 10px 0; font-weight: 600;">Statistiques globales</div>`;
                        analysisHtml += `
                        <div style="padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                            <div><span style="color: var(--text-secondary);">Trades:</span> <span style="color: var(--text-primary); font-weight: 600;">${g.total_trades}</span></div>
                            <div><span style="color: var(--text-secondary);">Win Rate:</span> <span style="color: var(--text-primary); font-weight: 600;">${g.win_rate}%</span></div>
                            <div><span style="color: var(--text-secondary);">Profit Factor:</span> <span style="color: var(--text-primary); font-weight: 600;">${g.profit_factor}</span></div>
                            <div><span style="color: var(--text-secondary);">Total P&L:</span> <span style="color: ${g.total_profit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${g.total_profit >= 0 ? '+' : ''}${g.total_profit?.toFixed(2)} EUR</span></div>
                            <div><span style="color: var(--text-secondary);">Moy Win:</span> <span style="color: var(--accent-green);">${g.avg_win?.toFixed(2)} EUR</span></div>
                            <div><span style="color: var(--text-secondary);">Moy Loss:</span> <span style="color: var(--accent-red);">${g.avg_loss?.toFixed(2)} EUR</span></div>
                            <div><span style="color: var(--text-secondary);">Max Win:</span> <span style="color: var(--accent-green);">${g.max_win?.toFixed(2)} EUR</span></div>
                            <div><span style="color: var(--text-secondary);">Max Loss:</span> <span style="color: var(--accent-red);">${g.max_loss?.toFixed(2)} EUR</span></div>
                        </div>
                    `;
                    }

                    // Afficher le rapport d'analyse
                    document.getElementById('strategist-analysis-content').innerHTML = analysisHtml || '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Aucune donnee d\'analyse</div>';

                    // ========== SECTION 2: Historique des analyses et decisions ==========
                    let logsHtml = '';

                    try {
                        const logsResp = await fetch(`${API_URL}/api/strategist/logs?limit=50`);
                        const logsData = await logsResp.json();

                        if (logsData.logs && logsData.logs.length > 0) {
                            logsData.logs.forEach(log => {
                                // Couleur selon le type
                                let typeColor = 'var(--text-secondary)';
                                let typeBg = 'rgba(148,163,184,0.2)';
                                let typeLabel = log.type;

                                if (log.type === 'ACTION_EXECUTED') {
                                    typeColor = 'var(--accent-purple)';
                                    typeBg = 'rgba(139,92,246,0.3)';
                                    typeLabel = 'EXECUTE';
                                } else if (log.type === 'ANALYSE_COMPLETE') {
                                    typeColor = 'var(--accent-green)';
                                    typeBg = 'rgba(16,185,129,0.2)';
                                    typeLabel = 'ANALYSE';
                                } else if (log.type === 'SUGGESTION') {
                                    typeColor = 'var(--accent-orange)';
                                    typeBg = 'rgba(245,158,11,0.2)';
                                    typeLabel = 'SUGGESTION';
                                } else if (log.type === 'ANALYSE_INCOMPLETE') {
                                    typeColor = 'var(--accent-red)';
                                    typeBg = 'rgba(239,68,68,0.2)';
                                    typeLabel = 'INCOMPLET';
                                }

                                // Formater la date
                                let dateStr = '--';
                                if (log.timestamp) {
                                    const dt = new Date(log.timestamp);
                                    dateStr = dt.toLocaleString('fr-FR', {
                                        day: '2-digit', month: '2-digit', year: '2-digit',
                                        hour: '2-digit', minute: '2-digit'
                                    });
                                }

                                // Details formatés selon le type
                                let detailsStr = '';
                                if (log.details) {
                                    if (log.type === 'ACTION_EXECUTED') {
                                        const d = log.details;
                                        if (d.action === 'AUGMENTER_SEUILS') {
                                            detailsStr = `<span style="color: var(--accent-purple); font-weight: 600;">Agent ${d.agent}</span>: Seuils augmentes automatiquement`;
                                        } else if (d.action === 'AJUSTER_TPSL') {
                                            detailsStr = `TP: ${d.old_tp}% → ${d.new_tp}% | SL: ${d.old_sl}% → ${d.new_sl}%`;
                                        } else if (d.action === 'DESACTIVER_AGENT') {
                                            detailsStr = `<span style="color: var(--accent-red); font-weight: 600;">Agent ${d.agent} DESACTIVE</span>`;
                                        } else {
                                            detailsStr = `Action: ${d.action}`;
                                        }
                                    } else if (log.type === 'ANALYSE_COMPLETE') {
                                        detailsStr = `Trades analysés: ${log.details.total_trades} | Win Rate: ${log.details.win_rate}% | Profit Factor: ${log.details.profit_factor} | Suggestions générées: ${log.details.suggestions_count}`;
                                    } else if (log.type === 'SUGGESTION') {
                                        detailsStr = `<span style="color: ${log.details.priority === 'critical' ? 'var(--accent-red)' : log.details.priority === 'high' ? 'var(--accent-orange)' : 'var(--accent-blue)'};">[${log.details.priority?.toUpperCase()}]</span> ${log.details.suggestion}`;
                                    } else if (log.type === 'ANALYSE_INCOMPLETE') {
                                        detailsStr = `Trades: ${log.details.trades_count}/${log.details.minimum} minimum requis`;
                                    } else {
                                        detailsStr = JSON.stringify(log.details).substring(0, 150);
                                    }
                                }

                                logsHtml += `
                                <div style="padding: 12px; border-left: 3px solid ${typeColor}; background: rgba(0,0,0,0.2); margin-bottom: 8px; border-radius: 0 6px 6px 0;">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 6px;">
                                        <span style="font-size: 18px; color: var(--text-secondary);">${dateStr}</span>
                                        <span style="background: ${typeBg}; color: ${typeColor}; padding: 2px 10px; border-radius: 4px; font-size: 18px; font-weight: 600;">${typeLabel}</span>
                                    </div>
                                    <div style="font-size: 18px; color: var(--text-primary); margin-bottom: 4px;">${log.reason}</div>
                                    ${detailsStr ? `<div style="font-size: 18px; color: var(--text-secondary);">${detailsStr}</div>` : ''}
                                </div>
                            `;
                            });
                        } else {
                            logsHtml = `<div style="color: var(--text-secondary); text-align: center; padding: 30px;">
                            <div style="font-size: 18px; margin-bottom: 10px;">Aucune analyse enregistree</div>
                            <div style="font-size: 18px;">Cliquez sur "Analyser" dans la section Strategist pour generer un rapport et enregistrer les decisions.</div>
                        </div>`;
                        }
                    } catch (logError) {
                        console.error('Erreur chargement logs decisions:', logError);
                        logsHtml = `<div style="color: var(--accent-red); text-align: center; padding: 20px;">Erreur chargement des logs</div>`;
                    }

                    document.getElementById('strategist-logs-content').innerHTML = logsHtml;

                } catch (error) {
                    console.error('Erreur chargement logs Strategist:', error);
                    document.getElementById('strategist-suggestions').innerHTML = `<div style="color: var(--accent-red);">Erreur: ${error.message}</div>`;
                    document.getElementById('strategist-analysis-content').innerHTML = `<div style="color: var(--accent-red);">Erreur: ${error.message}</div>`;
                    document.getElementById('strategist-logs-content').innerHTML = `<div style="color: var(--accent-red);">Erreur: ${error.message}</div>`;
                }
            }

            // ================================================================
            // SESSION FUNCTIONS
            // ================================================================
            async function loadSessionInfo() {
                try {
                    const response = await fetch(`${API_URL}/api/session`);
                    const session = await response.json();

                    if (session.active && session.id) {
                        // Session active
                        document.getElementById('current-session-id').textContent = session.id;
                        // Formater l'heure de debut
                        if (session.start_time) {
                            const dt = new Date(session.start_time);
                            document.getElementById('session-start-time').textContent = dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        } else {
                            document.getElementById('session-start-time').textContent = '--';
                        }
                        document.getElementById('session-trades-count').textContent = session.trades_count || 0;
                        const pnl = session.total_pnl || 0;
                        const pnlEl = document.getElementById('session-pnl-value');
                        pnlEl.textContent = `${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} EUR`;
                        pnlEl.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    } else {
                        // Pas de session active
                        document.getElementById('current-session-id').textContent = 'Aucune';
                        document.getElementById('session-start-time').textContent = '--';
                        document.getElementById('session-trades-count').textContent = '0';
                        document.getElementById('session-pnl-value').textContent = '0.00 EUR';
                        document.getElementById('session-pnl-value').style.color = 'var(--text-secondary)';
                    }
                } catch (error) {
                    console.error('Erreur chargement session:', error);
                    // En cas d'erreur, afficher "Erreur"
                    document.getElementById('current-session-id').textContent = 'Erreur';
                }
            }

            async function startNewSession() {
                if (!confirm('Demarrer une nouvelle session?\n\nLa session actuelle sera fermee, les logs sauvegardes, puis une nouvelle session sera creee.')) return;

                const btn = document.querySelector('button[onclick="startNewSession()"]');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'En cours...';

                try {
                    // 1. Fermer la session actuelle (si active) et sauvegarder les logs
                    // Utilise GET car POST bloque quand le serveur est sous charge MT5
                    const endResponse = await fetch(`${API_URL}/api/session/end`);
                    const endResult = await endResponse.json();
                    if (endResult.success) {
                        showNotification(`Session precedente terminee et archivee.`, 'info');
                    }

                    // 2. Demarrer une nouvelle session
                    const startResponse = await fetch(`${API_URL}/api/session/start`);
                    const startResult = await startResponse.json();
                    if (startResult.success) {
                        showNotification(`Nouvelle session demarree! Reset en cours...`, 'success');
                        // Reset complet du site via rechargement
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showNotification('Erreur creation session', 'error');
                    }
                } catch (error) {
                    console.error('Erreur startNewSession:', error);
                    showNotification('Erreur: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }

            async function endSession() {
                if (!confirm('Terminer la session?\n\nUn fichier de resume sera genere et la session sera fermee.\nAucune nouvelle session ne sera creee.')) return;

                const btn = document.querySelector('button[onclick="endSession()"]');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'En cours...';

                try {
                    // Utilise GET car POST bloque quand le serveur est sous charge MT5
                    const response = await fetch(`${API_URL}/api/session/end`);
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`Session terminee! Resume: ${result.log_file}`, 'success');
                        await loadSessionInfo();
                    } else {
                        showNotification(result.message || 'Erreur', 'error');
                    }
                } catch (error) {
                    console.error('Erreur endSession:', error);
                    showNotification('Erreur: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }

            async function exportSessionLog() {
                try {
                    const response = await fetch(`${API_URL}/api/session/export`);
                    const data = await response.json();

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `g11_session_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    showNotification('Logs de session exportes!', 'success');
                } catch (error) {
                    showNotification('Erreur export: ' + error.message, 'error');
                }
            }

            async function syncMT5Trades() {
                try {
                    showNotification('Synchronisation MT5 en cours...', 'info');
                    const response = await fetch(`${API_URL}/api/session/sync`, { method: 'POST' });
                    const data = await response.json();

                    if (data.success !== false) {
                        const newTrades = data.new_trades || 0;
                        const pnl = data.total_synced_pnl || 0;
                        showNotification(`Sync OK: ${newTrades} nouveaux trades, PnL: ${pnl.toFixed(2)} EUR`, 'success');
                    } else {
                        showNotification('Erreur sync: ' + (data.message || 'Erreur inconnue'), 'error');
                    }
                } catch (error) {
                    showNotification('Erreur sync MT5: ' + error.message, 'error');
                }
            }

            async function validatePositions() {
                try {
                    showNotification('Validation des positions en cours...', 'info');
                    const response = await fetch(`${API_URL}/api/positions/validate`, { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        let totalRemoved = 0;
                        let details = [];
                        for (const [agent, result] of Object.entries(data.results)) {
                            if (result.removed > 0) {
                                totalRemoved += result.removed;
                                details.push(`${agent}: ${result.removed} supprimee(s)`);
                            }
                        }
                        if (totalRemoved > 0) {
                            showNotification(`${totalRemoved} position(s) stale(s) supprimee(s): ${details.join(', ')}`, 'success');
                        } else {
                            showNotification('Toutes les positions sont valides', 'success');
                        }
                    } else {
                        showNotification('Erreur validation: ' + (data.message || 'Erreur inconnue'), 'error');
                    }
                } catch (error) {
                    showNotification('Erreur validation: ' + error.message, 'error');
                }
            }

            // ================================================================
            // AGENT TRADES MODAL FUNCTIONS
            // ================================================================
            async function showAgentTrades(agentId) {
                document.getElementById('agent-trades-modal').style.display = 'flex';

                const titleText = agentId === 'all' ? 'Tous les Trades' : `Trades - ${agentId.toUpperCase()}`;
                document.getElementById('agent-trades-title').textContent = titleText;

                await loadAgentTrades(agentId);
            }

            function closeAgentTrades() {
                document.getElementById('agent-trades-modal').style.display = 'none';
            }

            async function loadAgentTrades(agentId) {
                const tbody = document.getElementById('agent-trades-table');
                const summaryEl = document.getElementById('agent-trades-summary');

                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Chargement...</td></tr>';

                try {
                    // Charger les trades depuis l'API
                    const response = await fetch(`${API_URL}/api/trades?agent=${agentId}&limit=200`);
                    const data = await response.json();

                    const trades = data.trades || [];

                    if (trades.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--text-secondary);">Aucun trade trouve</td></tr>';
                        summaryEl.innerHTML = '';
                        return;
                    }

                    // Filtrer par agent si necessaire
                    const filteredTrades = agentId === 'all' ? trades : trades.filter(t => t.agent_id === agentId);

                    if (filteredTrades.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--text-secondary);">Aucun trade pour cet agent</td></tr>';
                        summaryEl.innerHTML = '';
                        return;
                    }

                    // Generer le tableau
                    tbody.innerHTML = filteredTrades.map(t => {
                        const pnl = t.profit_eur || t.profit || 0;
                        const pnlColor = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                        const dirColor = t.direction === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)';

                        // Formater la date
                        let dateStr = '--';
                        if (t.timestamp) {
                            const dt = new Date(t.timestamp);
                            dateStr = dt.toLocaleString('fr-FR', {
                                day: '2-digit', month: '2-digit', year: '2-digit',
                                hour: '2-digit', minute: '2-digit'
                            });
                        }

                        // Tronquer la raison de fermeture
                        const closeReason = (t.close_reason || '--').substring(0, 50) + ((t.close_reason || '').length > 50 ? '...' : '');

                        return `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 10px;">${dateStr}</td>
                            <td style="padding: 10px; text-transform: uppercase; font-weight: 600;">${t.agent_id || '--'}</td>
                            <td style="padding: 10px; text-align: right; font-family: monospace; color: var(--text-secondary);">${t.ticket || '--'}</td>
                            <td style="padding: 10px; color: ${dirColor}; font-weight: 600;">${t.direction || '--'}</td>
                            <td style="padding: 10px; text-align: right;">${t.volume || 0}</td>
                            <td style="padding: 10px; text-align: right;">$${(t.entry_price || 0).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right;">$${(t.exit_price || 0).toLocaleString()}</td>
                            <td style="padding: 10px; text-align: right; color: ${pnlColor}; font-weight: 600;">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} EUR</td>
                            <td style="padding: 10px; font-size: 18px; color: var(--text-secondary);" title="${t.close_reason || ''}">${closeReason}</td>
                        </tr>
                    `;
                    }).join('');

                    // Calculer le resume
                    const totalPnl = filteredTrades.reduce((sum, t) => sum + (t.profit_eur || t.profit || 0), 0);
                    const wins = filteredTrades.filter(t => (t.profit_eur || t.profit || 0) > 0).length;
                    const losses = filteredTrades.filter(t => (t.profit_eur || t.profit || 0) < 0).length;
                    const winRate = filteredTrades.length > 0 ? (wins / filteredTrades.length * 100).toFixed(1) : 0;

                    summaryEl.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 18px; color: var(--text-secondary);">Total Trades</div>
                        <div style="font-size: 24px; font-weight: 600;">${filteredTrades.length}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; color: var(--text-secondary);">Gagnants</div>
                        <div style="font-size: 24px; font-weight: 600; color: var(--accent-green);">${wins}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; color: var(--text-secondary);">Perdants</div>
                        <div style="font-size: 24px; font-weight: 600; color: var(--accent-red);">${losses}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; color: var(--text-secondary);">Win Rate</div>
                        <div style="font-size: 24px; font-weight: 600;">${winRate}%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Total</div>
                        <div style="font-size: 24px; font-weight: 600; color: ${totalPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)} EUR</div>
                    </div>
                `;

                } catch (error) {
                    console.error('Erreur chargement trades:', error);
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--accent-red);">Erreur: ${error.message}</td></tr>`;
                    summaryEl.innerHTML = '';
                }
            }

            // Notification
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                font-size: 18px;
                font-weight: 600;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: var(--accent-green); color: white;' : ''}
                ${type === 'error' ? 'background: var(--accent-red); color: white;' : ''}
                ${type === 'info' ? 'background: var(--accent-blue); color: white;' : ''}
            `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // (loadChartHistory defini plus haut - definition unique)
        </script>
        <style>
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }

                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }

                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        </style>

        <!-- MODAL STRATEGIST LOGS -->
        <div id="strategist-logs-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--bg-card); border-radius: 12px; padding: 24px; width: 900px; max-width: 95%; max-height: 85vh; overflow-y: auto; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; color: var(--accent-orange);">Logs Strategist IA</h2>
                    <button onclick="closeStrategistLogs()"
                        style="background: none; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer;">&times;</button>
                </div>

                <!-- Suggestions actuelles -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 18px; color: var(--accent-blue); margin-bottom: 12px; font-weight: 600;">
                        Suggestions d'amelioration</div>
                    <div id="strategist-suggestions"
                        style="background: var(--bg-input); border-radius: 8px; padding: 16px; font-size: 18px;">
                        Chargement...
                    </div>
                </div>

                <!-- Rapport d'analyse (patterns, performance) -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 18px; color: var(--accent-purple); margin-bottom: 12px; font-weight: 600;">
                        Rapport d'analyse</div>
                    <div id="strategist-analysis-content"
                        style="background: var(--bg-input); border-radius: 8px; padding: 16px; font-size: 18px; max-height: 300px; overflow-y: auto;">
                        Chargement...
                    </div>
                </div>

                <!-- Historique des analyses effectuees -->
                <div>
                    <div style="font-size: 18px; color: var(--accent-green); margin-bottom: 12px; font-weight: 600;">
                        Historique des analyses et decisions</div>
                    <div id="strategist-logs-content"
                        style="background: var(--bg-input); border-radius: 8px; padding: 16px; font-size: 18px; max-height: 300px; overflow-y: auto;">
                        Chargement...
                    </div>
                </div>

                <!-- Boutons -->
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="executeStrategistSuggestions()" class="btn btn-success"
                        style="font-size: 18px; padding: 10px 20px;"
                        title="Appliquer automatiquement les corrections critiques">Executer Corrections</button>
                    <button onclick="refreshStrategistLogs()" class="btn btn-secondary"
                        style="font-size: 18px; padding: 10px 20px;">Actualiser</button>
                    <button onclick="closeStrategistLogs()" class="btn btn-primary"
                        style="font-size: 18px; padding: 10px 20px;">Fermer</button>
                </div>
            </div>
        </div>

        <!-- MODAL TRADES PAR AGENT -->
        <div id="agent-trades-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--bg-card); border-radius: 12px; padding: 24px; width: 1000px; max-width: 95%; max-height: 85vh; overflow-y: auto; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="agent-trades-title" style="font-size: 24px; color: var(--accent-blue);">Trades - Agent</h2>
                    <button onclick="closeAgentTrades()"
                        style="background: none; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer;">&times;</button>
                </div>

                <!-- Tableau des trades -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 18px;">
                        <thead>
                            <tr style="background: var(--bg-input);">
                                <th style="padding: 12px; text-align: left;">Date/Heure</th>
                                <th style="padding: 12px; text-align: left;">Agent</th>
                                <th style="padding: 12px; text-align: right;">Ticket</th>
                                <th style="padding: 12px; text-align: left;">Direction</th>
                                <th style="padding: 12px; text-align: right;">Volume</th>
                                <th style="padding: 12px; text-align: right;">Prix Entree</th>
                                <th style="padding: 12px; text-align: right;">Prix Sortie</th>
                                <th style="padding: 12px; text-align: right;">P&L</th>
                                <th style="padding: 12px; text-align: left;">Raison Fermeture</th>
                            </tr>
                        </thead>
                        <tbody id="agent-trades-table">
                            <tr>
                                <td colspan="9"
                                    style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                    Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Resume -->
                <div id="agent-trades-summary"
                    style="margin-top: 20px; padding: 16px; background: var(--bg-input); border-radius: 8px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 16px;">
                </div>

                <!-- Boutons -->
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeAgentTrades()" class="btn btn-primary"
                        style="font-size: 18px; padding: 10px 20px;">Fermer</button>
                </div>
            </div>
        </div>

        <!-- MODAL GESTION API KEYS -->
        <div id="api-manager-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--bg-card); border-radius: 12px; padding: 24px; width: 700px; max-width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; color: var(--accent-blue);">Gestion des Cles API</h2>
                    <button onclick="closeApiManager()"
                        style="background: none; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer;">&times;</button>
                </div>

                <!-- Liste des cles -->
                <div id="api-keys-list" style="margin-bottom: 20px;"></div>

                <!-- Formulaire ajout -->
                <div style="background: var(--bg-input); border-radius: 8px; padding: 16px; margin-top: 16px;">
                    <div style="font-size: 18px; color: var(--accent-green); margin-bottom: 12px; font-weight: 600;">
                        Ajouter une nouvelle cle</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label
                                style="font-size: 18px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Nom</label>
                            <input type="text" id="new-api-name" placeholder="Ex: Claude Production"
                                style="width: 100%; padding: 12px; font-size: 18px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        </div>
                        <div>
                            <label
                                style="font-size: 18px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Provider</label>
                            <select id="new-api-provider"
                                onchange="updateModelDropdown('new-api-provider', 'new-api-model')"
                                style="width: 100%; padding: 12px; font-size: 18px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openai">OpenAI (GPT)</option>
                                <option value="google">Google (Gemini)</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="mistral">Mistral</option>
                                <option value="meta">Meta (Llama)</option>
                                <option value="cohere">Cohere</option>
                                <option value="xai">xAI (Grok)</option>
                                <option value="alibaba">Alibaba (Qwen)</option>
                                <option value="groq">Groq (Ultra-Fast)</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label
                            style="font-size: 18px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Cle
                            API (Requesty)</label>
                        <input type="text" id="new-api-key" placeholder="rqsty-sk-..."
                            style="width: 100%; padding: 12px; font-size: 18px; font-family: monospace; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </div>
                    <div style="margin-top: 12px;">
                        <label
                            style="font-size: 18px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Modele</label>
                        <select id="new-api-model"
                            style="width: 100%; padding: 12px; font-size: 18px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Groq)</option>
                            <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                            <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                        </select>
                    </div>
                    <button onclick="addApiKey()" class="btn btn-success"
                        style="width: 100%; margin-top: 16px; font-size: 18px; padding: 12px;">Ajouter cette
                        cle</button>
                </div>
            </div>
        </div>

        <!-- MODAL GRAPHIQUE EQUITE DETAILLE -->
        <div id="chart-detail-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--bg-card); border-radius: 16px; padding: 32px; width: 95%; max-width: 1400px; height: 85vh; display: flex; flex-direction: column; border: 2px solid var(--border);">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 id="chart-modal-title" style="font-size: 28px; margin: 0;">Courbe d'Equite - AGENT</h2>
                        <p id="chart-modal-subtitle"
                            style="font-size: 18px; color: var(--text-secondary); margin: 8px 0 0 0;">Session en cours
                        </p>
                    </div>
                    <button onclick="closeChartModal()"
                        style="background: none; border: none; color: var(--text-secondary); font-size: 36px; cursor: pointer; padding: 0 12px;">&times;</button>
                </div>

                <!-- Stats Summary -->
                <div
                    style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; background: var(--bg-input); border-radius: 12px; padding: 20px;">
                    <div style="text-align: center;">
                        <div id="chart-stat-closed"
                            style="font-size: 24px; font-weight: 700; color: var(--accent-green);">+0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Ferme</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="chart-stat-open" style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">
                            +0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Ouvert</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="chart-stat-total"
                            style="font-size: 24px; font-weight: 700; color: var(--text-primary);">+0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Total</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="chart-stat-max" style="font-size: 24px; font-weight: 700; color: var(--accent-green);">
                            +0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">Max Profit</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="chart-stat-min" style="font-size: 24px; font-weight: 700; color: var(--accent-red);">
                            -0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">Max Drawdown</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="chart-stat-points"
                            style="font-size: 24px; font-weight: 700; color: var(--text-primary);">0</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">Points</div>
                    </div>
                </div>

                <!-- Chart Area -->
                <div
                    style="flex: 1; position: relative; background: var(--bg-input); border-radius: 12px; padding: 20px; min-height: 300px;">
                    <canvas id="chart-detail-canvas" style="width: 100%; height: 100%;"></canvas>
                    <!-- Tooltip -->
                    <div id="chart-tooltip"
                        style="display: none; position: absolute; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; pointer-events: none; z-index: 10; min-width: 200px;">
                        <div id="tooltip-time"
                            style="font-size: 18px; color: var(--text-secondary); margin-bottom: 8px;"></div>
                        <div style="display: flex; gap: 16px;">
                            <div>
                                <span style="color: var(--text-secondary); font-size: 18px;">Ferme:</span>
                                <span id="tooltip-closed" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary); font-size: 18px;">Total:</span>
                                <span id="tooltip-open" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend & Info -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 16px; background: var(--bg-input); border-radius: 12px;">
                    <div style="display: flex; gap: 32px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div id="legend-closed-color" style="width: 24px; height: 4px; border-radius: 2px;"></div>
                            <span style="font-size: 18px;">P&L Positions Fermees (cumule)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div id="legend-open-color"
                                style="width: 24px; height: 4px; border-radius: 2px; opacity: 0.5;"></div>
                            <span style="font-size: 18px;">P&L Total (Ferme + Ouvert)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 2px; background: rgba(255,255,255,0.3);"></div>
                            <span style="font-size: 18px;">Ligne Zero</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="exportChartData()" class="btn btn-secondary"
                            style="font-size: 18px; padding: 10px 20px;">Exporter CSV</button>
                        <button onclick="closeChartModal()" class="btn btn-primary"
                            style="font-size: 18px; padding: 10px 20px;">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL GRAPHIQUE GLOBAL DETAILLE (8 COURBES) -->
        <div id="global-chart-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background: var(--bg-card); border-radius: 16px; padding: 32px; width: 96%; max-width: 1600px; height: 90vh; display: flex; flex-direction: column; border: 2px solid var(--accent-pink);">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="font-size: 32px; margin: 0; color: var(--accent-pink);">Performance Globale Detaillee
                        </h2>
                        <p id="global-chart-subtitle"
                            style="font-size: 18px; color: var(--text-secondary); margin: 8px 0 0 0;">
                            Toutes les courbes de performance - Session en cours
                        </p>
                    </div>
                    <button onclick="closeGlobalChartModal()"
                        style="background: none; border: none; color: var(--text-secondary); font-size: 42px; cursor: pointer; padding: 0 12px; transition: color 0.2s;"
                        onmouseover="this.style.color='white'"
                        onmouseout="this.style.color='var(--text-secondary)'">&times;</button>
                </div>

                <!-- Stats Summary - 2 rows - Clickable to toggle curves -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                    <!-- Row 1: Global Stats -->
                    <div id="stat-global" onclick="toggleGlobalCurve('global')"
                        style="background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%); border: 1px solid rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div id="global-stat-total" style="font-size: 28px; font-weight: 700; color: #ffffff;">0.00 EUR
                        </div>
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Global Total</div>
                    </div>
                    <div id="stat-session" onclick="toggleGlobalCurve('session')"
                        style="background: var(--bg-input); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div id="global-stat-session" style="font-size: 28px; font-weight: 700; color: #06b6d4;">0.00
                            EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Session (Realise)</div>
                    </div>
                    <div id="stat-floating" onclick="toggleGlobalCurve('floating')"
                        style="background: var(--bg-input); border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div id="global-stat-floating" style="font-size: 28px; font-weight: 700; color: #a855f7;">0.00
                            EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">P&L Flottant (Non-realise)</div>
                    </div>
                    <div style="background: var(--bg-input); border-radius: 12px; padding: 16px; text-align: center;">
                        <div id="global-stat-points"
                            style="font-size: 28px; font-weight: 700; color: var(--text-primary);">0</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">Points enregistres</div>
                    </div>
                </div>

                <!-- Stats Row 2: Per-Agent Stats - Clickable -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div id="stat-fibo1" onclick="toggleGlobalCurve('fibo1')"
                        style="background: rgba(59,130,246,0.1); border: 1px solid var(--accent-blue); border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div id="global-stat-fibo1"
                            style="font-size: 22px; font-weight: 700; color: var(--accent-blue);">0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">FIBO1</div>
                    </div>
                    <div id="stat-fibo2" onclick="toggleGlobalCurve('fibo2')"
                        style="background: rgba(16,185,129,0.1); border: 1px solid var(--accent-green); border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div id="global-stat-fibo2"
                            style="font-size: 22px; font-weight: 700; color: var(--accent-green);">0.00 EUR</div>
                        <div style="font-size: 18px; color: var(--text-secondary);">FIBO2</div>
                    </div>
                    <div id="stat-fibo3" onclick="toggleGlobalCurve('fibo3')"
                        style="background: rgba(236,72,153,0.15); border: 1px solid #ec4899; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div id="global-stat-fibo3" style="font-size: 22px; font-weight: 700; color: #ec4899;">0.00 EUR
                        </div>
                        <div style="font-size: 18px; color: var(--text-secondary);">FIBO3</div>
                    </div>
                    <div
                        style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.5); border-radius: 12px; padding: 12px; text-align: center;">
                        <div id="global-stat-master" style="font-size: 22px; font-weight: 700; color: #ffffff;">0.00 EUR
                        </div>
                        <div style="font-size: 18px; color: var(--text-secondary);">MASTER</div>
                    </div>
                </div>

                <!-- Chart Area -->
                <div
                    style="flex: 1; position: relative; background: var(--bg-input); border-radius: 12px; padding: 20px; min-height: 400px;">
                    <canvas id="global-chart-canvas" style="width: 100%; height: 100%;"></canvas>
                    <!-- Tooltip -->
                    <div id="global-chart-tooltip"
                        style="display: none; position: absolute; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; pointer-events: none; z-index: 10; min-width: 280px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                        <div id="global-tooltip-time"
                            style="font-size: 18px; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="width: 12px; height: 3px; background: #ffffff; border-radius: 2px;"></span>
                                <span style="color: var(--text-secondary); font-size: 18px;">Global:</span>
                                <span id="global-tooltip-total" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span
                                    style="width: 12px; height: 3px; background: var(--accent-blue); border-radius: 2px;"></span>
                                <span style="color: var(--text-secondary); font-size: 18px;">FIBO1:</span>
                                <span id="global-tooltip-fibo1" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span
                                    style="width: 12px; height: 3px; background: var(--accent-green); border-radius: 2px;"></span>
                                <span style="color: var(--text-secondary); font-size: 18px;">FIBO2:</span>
                                <span id="global-tooltip-fibo2" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="width: 12px; height: 3px; background: #ec4899; border-radius: 2px;"></span>
                                <span style="color: var(--text-secondary); font-size: 18px;">FIBO3:</span>
                                <span id="global-tooltip-fibo3" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="width: 12px; height: 3px; background: #a855f7; border-radius: 2px;"></span>
                                <span style="color: var(--text-secondary); font-size: 18px;">Flottant:</span>
                                <span id="global-tooltip-floating" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="width: 12px; height: 3px; background: #06b6d4; border-radius: 2px;"></span>
                                <span style="color: var(--text-secondary); font-size: 18px;">Session:</span>
                                <span id="global-tooltip-session" style="font-size: 18px; font-weight: 600;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend - Clickable to toggle curves -->
                <div
                    style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 16px; padding: 16px; background: var(--bg-input); border-radius: 12px;">
                    <div id="legend-global" onclick="toggleGlobalCurve('global')"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div style="width: 32px; height: 4px; background: #ffffff; border-radius: 2px;"></div>
                        <span style="font-size: 18px; font-weight: 600; color: #ffffff;">Global Total</span>
                    </div>
                    <div id="legend-fibo1" onclick="toggleGlobalCurve('fibo1')"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div style="width: 32px; height: 4px; background: var(--accent-blue); border-radius: 2px;">
                        </div>
                        <span style="font-size: 18px; font-weight: 600; color: var(--accent-blue);">FIBO1</span>
                    </div>
                    <div id="legend-fibo2" onclick="toggleGlobalCurve('fibo2')"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div style="width: 32px; height: 4px; background: var(--accent-green); border-radius: 2px;">
                        </div>
                        <span style="font-size: 18px; font-weight: 600; color: var(--accent-green);">FIBO2</span>
                    </div>
                    <div id="legend-fibo3" onclick="toggleGlobalCurve('fibo3')"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div style="width: 32px; height: 4px; background: #ec4899; border-radius: 2px;"></div>
                        <span style="font-size: 18px; font-weight: 600; color: #ec4899;">FIBO3</span>
                    </div>
                    <div id="legend-floating" onclick="toggleGlobalCurve('floating')"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div style="width: 32px; height: 4px; background: #a855f7; border-radius: 2px;"></div>
                        <span style="font-size: 18px; font-weight: 600; color: #a855f7;">P&L Flottant</span>
                    </div>
                    <div id="legend-session" onclick="toggleGlobalCurve('session')"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;"
                        title="Cliquer pour afficher/masquer">
                        <div style="width: 32px; height: 4px; background: #06b6d4; border-radius: 2px;"></div>
                        <span style="font-size: 18px; font-weight: 600; color: #06b6d4;">P&L Session</span>
                    </div>
                </div>

                <!-- Footer buttons -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
                    <button onclick="exportGlobalChartData()" class="btn btn-secondary"
                        style="font-size: 18px; padding: 12px 24px;">
                        Exporter CSV
                    </button>
                    <button onclick="closeGlobalChartModal()" class="btn btn-primary"
                        style="font-size: 18px; padding: 12px 24px;">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
</body>

</html>